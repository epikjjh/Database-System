cscope 15 $HOME/mysql/Lab/project_final -q 0000000307 0000046054
	@include/bpt.h

1 #i‚de‡
__BPT_H__


2 
	#__BPT_H__


	)

4 
›í_èbÀ
(c⁄° * 
fûíame
);

5 * 
föd
(
èbÀ_id
, 
uöt64_t
 
key
);

6 
ö£π
(
èbÀ_id
, 
uöt64_t
 
key
, c⁄° * 
vÆue
);

7 
dñëe
(
èbÀ_id
, 
uöt64_t
 
key
);

9 
¥öt_åì
(
èbÀ_id
);

13 
öô_db
(
num_buf
);

15 
˛o£_èbÀ
(
èbÀ_id
);

17 
shutdown_db
();

	@include/file.h

1 
	~<°ddef.h
>

2 
	~<öây≥s.h
>

4 
	#BPTREE_INTERNAL_ORDER
 249

5 
	#BPTREE_LEAF_ORDER
 32

6 

	)

7 
	#PAGE_SIZE
 4096

	)

9 
	#SIZE_KEY
 8

	)

10 
	#SIZE_VALUE
 120

	)

11 
	#SIZE_RECORD
 (
SIZE_KEY
 + 
SIZE_VALUE
)

	)

13 
	#BPTREE_MAX_NODE
 (1024 * 1024)

14 

	)

15 
	#OUTPUT_ORDER
 16

	)

27 
	s_Rec‹d
 {

28 
uöt64_t
 
	mkey
;

29 
	mvÆue
[
SIZE_VALUE
];

30 } 
	tRec‹d
;

32 
	s_I¡î«lRec‹d
 {

33 
uöt64_t
 
	mkey
;

34 
off_t
 
	moff£t
;

35 } 
	tI¡î«lRec‹d
;

38 
	s_Resu…
 {

39 
uöt64_t
 
	mkey1
;

40 
	mvÆue1
[
SIZE_VALUE
];

41 
uöt64_t
 
	mkey2
;

42 
	mvÆue2
[
SIZE_VALUE
];

43 } 
	tResu…
;

45 
	s_Page
 {

46 
	mbyãs
[
PAGE_SIZE
];

49 
off_t
 
	mfûe_off£t
;

50 } 
	tPage
;

52 
	s_FªePage
 {

53 
off_t
 
	m√xt
;

54 
	mª£rved
[
PAGE_SIZE
 - 8];

57 
off_t
 
	mfûe_off£t
;

58 } 
	tFªePage
;

60 
	s_HódîPage
 {

61 
off_t
 
	m‰ìli°
;

62 
off_t
 
	mroŸ_off£t
;

63 
uöt64_t
 
	mnum_∑ges
;

64 
off_t
 
	m∑ge_l¢
;

65 
	mª£rved
[
PAGE_SIZE
 - 32];

68 
off_t
 
	mfûe_off£t
;

69 } 
	tHódîPage
;

71 
	#INTERNAL_KEY
(
n
, 
i
Ë(“)->
úec‹ds
[(i)+1].
key
)

	)

72 
	#INTERNAL_OFFSET
(
n
, 
i
Ë(“)->
úec‹ds
[(i)].
off£t
)

	)

73 
	s_I¡î«lPage
 {

76 
off_t
 
	m∑ª¡
;

77 
	mis_Àaf
;

78 
	mnum_keys
;

79 
	mª£rved_1
[8];

80 
off_t
 
	m∑ge_l¢
;

81 
	mª£rved_2
[112 - 32];

82 
I¡î«lRec‹d
 
	múec‹ds
[
BPTREE_INTERNAL_ORDER
];

84 
	m•a˚
[
PAGE_SIZE
];

87 
off_t
 
	mfûe_off£t
;

88 } 
	tI¡î«lPage
;

90 
	#LEAF_KEY
(
n
, 
i
Ë(“)->
ªc‹ds
[(i)].
key
)

	)

91 
	#LEAF_VALUE
(
n
, 
i
Ë(“)->
ªc‹ds
[(i)].
vÆue
)

	)

92 
	s_LófPage
 {

95 
off_t
 
	m∑ª¡
;

96 
	mis_Àaf
;

97 
	mnum_keys
;

98 
	mª£rved_1
[8];

99 
off_t
 
	m∑ge_l¢
;

100 
	mª£rved_2
[120 - 32];

101 
off_t
 
	msiblög
;

102 
Rec‹d
 
	mªc‹ds
[
BPTREE_LEAF_ORDER
-1];

104 
	m•a˚
[
PAGE_SIZE
];

108 
off_t
 
	mfûe_off£t
;

109 } 
	tLófPage
;

111 
	s_NodePage
 {

114 
off_t
 
	m∑ª¡
;

115 
	mis_Àaf
;

116 
	mnum_keys
;

117 
	mª£rved_1
[8];

118 
off_t
 
	m∑ge_l¢
;

120 
	m•a˚
[
PAGE_SIZE
];

124 
off_t
 
	mfûe_off£t
;

125 } 
	tNodePage
;

128 
	#RESULT_KEY1
(
n
, 
i
Ë(“)->
ªsu…s
[(i)].
key1
)

	)

129 
	#RESULT_VALUE1
(
n
, 
i
Ë(“)->
ªsu…s
[(i)].
vÆue1
)

	)

130 
	#RESULT_KEY2
(
n
, 
i
Ë(“)->
ªsu…s
[(i)].
key2
)

	)

131 
	#RESULT_VALUE2
(
n
, 
i
Ë(“)->
ªsu…s
[(i)].
vÆue2
)

	)

132 
	s_OuçutPage
 {

134 
Resu…
 
	mªsu…s
[
OUTPUT_ORDER
];

135 
	m•a˚
[
PAGE_SIZE
];

139 
off_t
 
	mfûe_off£t
;

140 } 
	tOuçutPage
;

143 
›í_èbÀ
(c⁄° * 
fûíame
);

147 
˛o£_db
(
èbÀ_id
);

150 
off_t
 
gë_‰ì_∑ge
(
èbÀ_id
);

153 
put_‰ì_∑ge
(
èbÀ_id
, 
off_t
 
∑ge_off£t
);

156 
ex∑nd_fûe
(
èbÀ_id
, 
size_t
 
˙t_∑ge_to_ex∑nd
);

159 
lﬂd_∑ge
(
èbÀ_id
, 
off_t
 
off£t
, 
Page
* 
∑ge
);

162 
Êush_∑ge
(
èbÀ_id
, 
Page
* 
∑ge
);

164 
HódîPage
 
dbhódî
[10];

168 
	s_Buf„r
{

169 
Page
 *
	m‰ame
;

170 
	mèbÀ_id
;

171 
off_t
 
	m∑ge_off£t
;

172 
	mis_dúty
;

174 
	mªfbô
;

175 } 
	tBuf„r
;

178 
lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
off_t
 
off£t
, 
Page
* 
∑ge
);

181 
Page
* 
check_buf„r_f‹_lﬂd
(
èbÀ_id
, 
off_t
 
off£t
);

184 
check_buf„r_f‹_Êush
(
èbÀ_id
, 
off_t
 
off£t
);

186 
ª∂a˚_∑ge
(
FILE
 *
fûe
);

189 
Êush_∑ge_to_buf„r
(
èbÀ_id
, 
Page
* 
∑ge
);

192 
joö_èbÀ
(
èbÀ_id_1
, 
èbÀ_id_2
, *
∑th«me
);

194 
èbÀ_öfo
(
èbÀ_id
, 
uöt64_t
 *
num_keys
, uöt64_à*
mö_key
, uöt64_à*
max_key
);

196 
wrôe_ouçut_buf„r
(
FILE
 *
fûe
, 
uöt64_t
 
key1
, *
vÆue1
, uöt64_à
key2
, *
vÆue2
);

198 
lﬂd_ouçut_∑ge
(
Page
 *
∑ge
);

200 
Êush_ouçut_∑ge
(
FILE
 *
fûe
, 
Page
 *
∑ge
);

202 
sync_buf„r
(
FILE
 *
fûe
);

205 
	s_LogRec‹d
{

207 
off_t
 
	ml¢
;

208 
off_t
 
	m¥ev_l¢
;

209 
	mxid
;

210 
	mty≥
;

216 
	mèbÀ_id
;

217 
	m≤um
;

218 
	moff£t
;

219 
	mÀngth
;

220 
	mﬁd_image
[120];

221 
	m√w_image
[120];

223 }
	tLogRec‹d
;

227 
begö_å™ß˘i⁄
();

232 
commô_å™ß˘i⁄
();

236 
ab‹_å™ß˘i⁄
();

240 
upd©e
(
èbÀ_id
, 
öt64_t
 
key
, *
vÆue
);

	@src/bpt.c

4 
	#Vîsi⁄
 "1.14"

	)

57 
	~<°dio.h
>

58 
	~<°dlib.h
>

59 
	~<°dboﬁ.h
>

60 
	~<°döt.h
>

61 
	~<°rög.h
>

62 
	~<öây≥s.h
>

63 
	~<as£π.h
>

64 
	~<f˙é.h
>

65 
	~<uni°d.h
>

66 
	~"b±.h
"

67 
	~"fûe.h
"

68 #ifde‡
WINDOWS


69 
	#boﬁ
 

	)

70 
	#Ál£
 0

	)

71 
	#åue
 1

	)

78 
	#MIN_ORDER
 3

	)

79 
	#MAX_ORDER
 256

	)

82 
	#LICENSE_FILE
 "LICENSE.txt"

	)

83 
	#LICENSE_WARRANTEE
 0

	)

84 
	#LICENSE_WARRANTEE_START
 592

	)

85 
	#LICENSE_WARRANTEE_END
 624

	)

86 
	#LICENSE_CONDITIONS
 1

	)

87 
	#LICENSE_CONDITIONS_START
 70

	)

88 
	#LICENSE_CONDITIONS_END
 625

	)

91 
HódîPage
 
dbhódî
[10];

92 
dbfûe
[10];

93 
	gèbÀ_ids
[10] = {0,};

105 
	g‹dî_öã∫Æ
 = 
BPTREE_INTERNAL_ORDER
;

106 
	g‹dî_Àaf
 = 
BPTREE_LEAF_ORDER
;

113 
boﬁ
 
	gvîbo£_ouçut
 = 
Ál£
;

116 
Buf„r
 *
	gbuf_mgr
;

117 
	gbuf_size
 = -1;

118 
	g˛ock_h™d
 = 0;

119 
	gèrgë_buf
 = 0;

123 
LogRec‹d
 
	glog_buf
[30000];

129 
li˚n£_nŸi˚
( );

130 
¥öt_li˚n£
–
li˚n˚_∑π
 );

131 
ußge_1
( );

132 
ußge_2
( );

133 
föd_™d_¥öt
(
èbÀ_id
, 
uöt64_t
 
key
);

134 
boﬁ
 
föd_Àaf
(
èbÀ_id
, 
uöt64_t
 
key
, 
LófPage
* 
out_Àaf_node
);

137 
°¨t_√w_åì
(
èbÀ_id
, 
uöt64_t
 
key
, c⁄° * 
vÆue
);

138 
ö£π_öto_Àaf
(
èlbe_id
, 
LófPage
* 
Àaf_node
, 
uöt64_t
 
key
, c⁄° * 
vÆue
);

139 
ö£π_öto_Àaf_a·î_•lôtög
(
èbÀ_id
, 
LófPage
* 
Àaf_node
, 
uöt64_t
 
key
, c⁄° * 
vÆue
);

140 
ö£π_öto_∑ª¡
(
èbÀ_id
, 
NodePage
* 
À·
, 
uöt64_t
 
key
, NodePage* 
right
);

141 
ö£π_öto_√w_roŸ
(
èbÀ_id
, 
NodePage
* 
À·
, 
uöt64_t
 
key
, NodePage* 
right
);

142 
gë_À·_ödex
(
I¡î«lPage
* 
∑ª¡
, 
off_t
 
À·_off£t
);

143 
ö£π_öto_node
(
I¡î«lPage
 * 
∑ª¡
, 
À·_ödex
, 
uöt64_t
 
key
, 
off_t
 
right_off£t
);

144 
ö£π_öto_node_a·î_•lôtög
(
èbÀ_id
, 
I¡î«lPage
* 
∑ª¡
, 
À·_ödex
, 
uöt64_t
 
key
, 
off_t
 
right_off£t
);

147 
gë_√ighb‹_ödex
(
èbÀ_id
, 
NodePage
* 
node_∑ge
);

148 
adju°_roŸ
(
èbÀ_id
);

149 
cﬂÀs˚_nodes
(
èbÀ_id
, 
NodePage
* 
node_∑ge
, NodePage* 
√ighb‹_∑ge
,

150 
√ighb‹_ödex
, 
k_¥ime
);

151 
ªdi°ribuã_nodes
(
èbÀ_id
, 
NodePage
* 
node_∑ge
, NodePage* 
√ighb‹_∑ge
,

152 
√ighb‹_ödex
,

153 
k_¥ime_ödex
, 
k_¥ime
);

154 
dñëe_íåy
(
èbÀ_id
, 
NodePage
* 
node_∑ge
, 
uöt64_t
 
key
);

163 
	$li˚n£_nŸi˚
( ) {

164 
	`¥ötf
("bpt version %s -- Copyright (C) 2010 Amittai Aviram "

165 "hâp://www.amôèi.com\n", 
Vîsi⁄
);

166 
	`¥ötf
("ThisÖrogram comes with ABSOLUTELY NO WARRANTY; for details "

170 
	}
}

175 
	$¥öt_li˚n£
–
li˚n£_∑π
 ) {

176 
°¨t
, 
íd
, 
löe
;

177 
FILE
 * 
Â
;

178 
buf„r
[0x100];

180 
li˚n£_∑π
) {

181 
LICENSE_WARRANTEE
:

182 
°¨t
 = 
LICENSE_WARRANTEE_START
;

183 
íd
 = 
LICENSE_WARRANTEE_END
;

185 
LICENSE_CONDITIONS
:

186 
°¨t
 = 
LICENSE_CONDITIONS_START
;

187 
íd
 = 
LICENSE_CONDITIONS_END
;

193 
Â
 = 
	`f›í
(
LICENSE_FILE
, "r");

194 i‡(
Â
 =
NULL
) {

195 
	`≥º‹
("print_license: fopen");

196 
	`exô
(
EXIT_FAILURE
);

198 
löe
 = 0;Üöê< 
°¨t
;Üine++)

199 
	`fgës
(
buf„r
, (buf„r), 
Â
);

200  ; 
löe
 < 
íd
;Üine++) {

201 
	`fgës
(
buf„r
, (buf„r), 
Â
);

202 
	`¥ötf
("%s", 
buf„r
);

204 
	`f˛o£
(
Â
);

205 
	}
}

209 
	$ußge_1
( ) {

210 
	`¥ötf
("B+ Tªêo‡Ordî %d(I¡î«l).\n", 
‹dî_öã∫Æ
);

211 
	`¥ötf
("Following Silberschatz, Korth, Sidarshan, Database Concepts, "

216 
	`¥ötf
("(%d <‹dî <%d).\n", 
MIN_ORDER
, 
MAX_ORDER
);

217 
	`¥ötf
("To start with input fromá file ofÇewline-delimited integers, \n"

220 
	}
}

224 
	$ußge_2
( ) {

225 
	`¥ötf
("Enterány ofÅhe following commandsáfterÅheÖrompt > :\n"

241 
	}
}

245 
	$›í_èbÀ
(c⁄° * 
fûíame
) {

246 
i
, 
èbÀ_id
;

247 
size_t
 
Àn
;

249 
Àn
 = 
	`°æí
(
fûíame
);

251 if(()
Àn
 == 5){

252 
èbÀ_id
 = 
fûíame
[4];

253 
i
 = 
èbÀ_id
 - '0' - 1;

255 if(()
Àn
 == 6){

256 
i
 = 9;

260 
	`¥ötf
("Wrong input!\n");

264 
dbfûe
[
i
] = 
	`›í
(
fûíame
, 
O_RDWR
);

265 i‡(
dbfûe
[
i
] < 0) {

267 
dbfûe
[
i
] = 
	`›í
(
fûíame
, 
O_CREAT
|
O_RDWR
, 
S_IRUSR
|
S_IWUSR
);

268 i‡(
dbfûe
[
i
] < 0) {

269 
	`as£π
("failedÅo createÇew db file");

273 
	`mem£t
((
dbhódî
+
i
), 0, 
PAGE_SIZE
);

274 
dbhódî
[
i
].
‰ìli°
 = 0;

275 
dbhódî
[
i
].
roŸ_off£t
 = 0;

276 
dbhódî
[
i
].
num_∑ges
 = 1;

277 
dbhódî
[
i
].
fûe_off£t
 = 0;

278 
	`Êush_∑ge_to_buf„r
(
i
+1, (
Page
*)(
dbhódî
 + i));

281 
	`lﬂd_∑ge_‰om_buf„r
(
i
+1, 0, (
Page
*)(
dbhódî
+i));

284 if(
dbhódî
[
i
].
num_∑ges
 == 0){

285 
dbhódî
[
i
].
num_∑ges
 = 1;

286 
	`Êush_∑ge_to_buf„r
(
i
+1, (
Page
*)(
dbhódî
 + i));

288 
dbhódî
[
i
].
fûe_off£t
 = 0;

291  
i
+1;

292 
	}
}

295 
	$˛o£_db
(
èbÀ_id
) {

296 
	`˛o£
(
dbfûe
[
èbÀ_id
 - 1]);

297 
	}
}

312 
off_t
 
	gqueue
[
BPTREE_MAX_NODE
];

313 
	$¥öt_åì
(
èbÀ_id
) {

315 
i
;

316 
‰⁄t
 = 0;

317 
ª¨
 = 0;

319 i‡(
dbhódî
[
èbÀ_id
 - 1].
roŸ_off£t
 == 0) {

320 
	`¥ötf
("EmptyÅree.\n");

324 
queue
[
ª¨
] = 
dbhódî
[
èbÀ_id
 - 1].
roŸ_off£t
;

325 
ª¨
++;

326 
queue
[
ª¨
] = 0;

327 
ª¨
++;

328 
‰⁄t
 < 
ª¨
) {

329 
off_t
 
∑ge_off£t
 = 
queue
[
‰⁄t
];

330 
‰⁄t
++;

332 i‡(
∑ge_off£t
 == 0) {

333 
	`¥ötf
("\n");

335 i‡(
‰⁄t
 =
ª¨
) ;

338 
queue
[
ª¨
] = 0;

339 
ª¨
++;

343 
NodePage
 
node_∑ge
;

344 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
∑ge_off£t
, (
Page
*)&
node_∑ge
);

345 i‡(
node_∑ge
.
is_Àaf
 == 1) {

347 
LófPage
* 
Àaf_node
 = (LófPage*)&
node_∑ge
;

348 
i
 = 0; i < 
Àaf_node
->
num_keys
; i++) {

349 
	`¥ötf
("%" 
PRIu64
 " ", 
	`LEAF_KEY
(
Àaf_node
, 
i
));

351 
	`¥ötf
("| ");

354 
I¡î«lPage
* 
öã∫Æ_node
 = (I¡î«lPage*)&
node_∑ge
;

355 
i
 = 0; i < 
öã∫Æ_node
->
num_keys
; i++) {

356 
	`¥ötf
("%" 
PRIu64
 " ", 
	`INTERNAL_KEY
(
öã∫Æ_node
, 
i
));

357 
queue
[
ª¨
] = 
	`INTERNAL_OFFSET
(
öã∫Æ_node
, 
i
);

358 
ª¨
++;

360 
queue
[
ª¨
] = 
	`INTERNAL_OFFSET
(
öã∫Æ_node
, 
i
);

361 
ª¨
++;

362 
	`¥ötf
("| ");

365 
	}
}

370 
	$föd_™d_¥öt
(
èbÀ_id
, 
uöt64_t
 
key
) {

371 * 
vÆue_found
 = 
NULL
;

372 
vÆue_found
 = 
	`föd
(
èbÀ_id
, 
key
);

373 i‡(
vÆue_found
 =
NULL
) {

374 
	`¥ötf
("Rec‹dÇŸ found undî key %" 
PRIu64
 ".\n", 
key
);

377 
	`¥ötf
("key %" 
PRIu64
 ", vÆuê[%s].\n", 
key
, 
vÆue_found
);

378 
	`‰ì
(
vÆue_found
);

380 
	}
}

387 
boﬁ
 
	$föd_Àaf
(
èbÀ_id
, 
uöt64_t
 
key
, 
LófPage
* 
out_Àaf_node
) {

388 
i
 = 0;

389 
off_t
 
roŸ_off£t
 = 
dbhódî
[
èbÀ_id
 - 1].root_offset;

391 i‡(
roŸ_off£t
 == 0) {

392  
Ál£
;

395 
NodePage
 
∑ge
;

396 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
roŸ_off£t
, (
Page
*)&
∑ge
);

398 !
∑ge
.
is_Àaf
) {

399 
I¡î«lPage
* 
öã∫Æ_node
 = (I¡î«lPage*)&
∑ge
;

401 
i
 = 0;

402 
i
 < 
öã∫Æ_node
->
num_keys
) {

403 i‡(
key
 >
	`INTERNAL_KEY
(
öã∫Æ_node
, 
i
)) i++;

407 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
	`INTERNAL_OFFSET
(
öã∫Æ_node
, 
i
), (
Page
*)&
∑ge
);

410 
	`mem˝y
(
out_Àaf_node
, &
∑ge
, (
LófPage
));

412  
åue
;

413 
	}
}

419 * 
	$föd
(
èbÀ_id
, 
uöt64_t
 
key
) {

420 
i
 = 0;

421 * 
out_vÆue
;

423 
LófPage
 
Àaf_node
;

424 i‡(!
	`föd_Àaf
(
èbÀ_id
, 
key
, &
Àaf_node
)) {

425  
NULL
;

428 
i
 = 0; i < 
Àaf_node
.
num_keys
; i++) {

429 i‡(
	`LEAF_KEY
(&
Àaf_node
, 
i
Ë=
key
) {

430 
out_vÆue
 = (*)
	`mÆloc
(
SIZE_VALUE
 * ());

431 
	`mem˝y
(
out_vÆue
, 
	`LEAF_VALUE
(&
Àaf_node
, 
i
), 
SIZE_VALUE
);

432  
out_vÆue
;

436  
NULL
;

437 
	}
}

442 
	$cut
–
Àngth
 ) {

443 i‡(
Àngth
 % 2 == 0)

444  
Àngth
/2;

446  
Àngth
/2 + 1;

447 
	}
}

454 
	$gë_À·_ödex
(
I¡î«lPage
* 
∑ª¡
, 
off_t
 
À·_off£t
) {

456 
À·_ödex
 = 0;

457 
À·_ödex
 <
∑ª¡
->
num_keys
 &&

458 
	`INTERNAL_OFFSET
(
∑ª¡
, 
À·_ödex
Ë!
À·_off£t
)

459 
À·_ödex
++;

460  
À·_ödex
;

461 
	}
}

467 
	$ö£π_öto_Àaf
(
èbÀ_id
, 
LófPage
* 
Àaf_node
, 
uöt64_t
 
key
, c⁄° * 
vÆue
) {

468 
ö£πi⁄_poöt
;

469 
i
;

471 
ö£πi⁄_poöt
 = 0;

472 
ö£πi⁄_poöt
 < 
Àaf_node
->
num_keys
 &&

473 
	`LEAF_KEY
(
Àaf_node
, 
ö£πi⁄_poöt
Ë< 
key
)

474 
ö£πi⁄_poöt
++;

477 
i
 = 
Àaf_node
->
num_keys
 - 1; i >
ö£πi⁄_poöt
; i--) {

478 
	`LEAF_KEY
(
Àaf_node
, 
i
+1) = LEAF_KEY(leaf_node, i);

479 
	`mem˝y
(
	`LEAF_VALUE
(
Àaf_node
, 
i
+1), LEAF_VALUE÷óf_node, i), 
SIZE_VALUE
);

482 
	`LEAF_KEY
(
Àaf_node
, 
ö£πi⁄_poöt
Ë
key
;

483 
	`mem˝y
(
	`LEAF_VALUE
(
Àaf_node
, 
ö£πi⁄_poöt
), 
vÆue
, 
SIZE_VALUE
);

484 
Àaf_node
->
num_keys
++;

487 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
Àaf_node
);

488 
	}
}

495 
	$ö£π_öto_Àaf_a·î_•lôtög
(
èbÀ_id
, 
LófPage
* 
Àaf
, 
uöt64_t
 
key
, c⁄° * 
vÆue
) {

497 
ö£πi⁄_ödex
, 
•lô
, 
i
, 
j
;

498 
uöt64_t
 
√w_key
;

501 
LófPage
 
√w_Àaf
;

502 
√w_Àaf
.
is_Àaf
 = 
åue
;

503 
√w_Àaf
.
num_keys
 = 0;

505 
ö£πi⁄_ödex
 = 0;

506 
ö£πi⁄_ödex
 < 
‹dî_Àaf
 - 1 && 
	`LEAF_KEY
(
Àaf
, in£πi⁄_ödexË< 
key
)

507 
ö£πi⁄_ödex
++;

509 
•lô
 = 
	`cut
(
‹dî_Àaf
 - 1);

511 i‡(
ö£πi⁄_ödex
 < 
•lô
) {

513 
i
 = 
•lô
 - 1, 
j
 = 0; i < 
‹dî_Àaf
 - 1; i++, j++) {

514 
	`LEAF_KEY
(&
√w_Àaf
, 
j
ËLEAF_KEY(
Àaf
, 
i
);

515 
	`mem˝y
(
	`LEAF_VALUE
(&
√w_Àaf
, 
j
), LEAF_VALUE(
Àaf
, 
i
), 
SIZE_VALUE
);

517 
√w_Àaf
.
num_keys
++;

518 
Àaf
->
num_keys
--;

521 
i
 = 
•lô
 - 2; i >
ö£πi⁄_ödex
; i--) {

522 
	`LEAF_KEY
(
Àaf
, 
i
+1) = LEAF_KEY(leaf, i);

523 
	`mem˝y
(
	`LEAF_VALUE
(
Àaf
, 
i
+1), LEAF_VALUE÷óf, i), 
SIZE_VALUE
);

525 
	`LEAF_KEY
(
Àaf
, 
ö£πi⁄_ödex
Ë
key
;

526 
	`mem˝y
(
	`LEAF_VALUE
(
Àaf
, 
ö£πi⁄_ödex
), 
vÆue
, 
SIZE_VALUE
);

527 
Àaf
->
num_keys
++;

530 
i
 = 
•lô
, 
j
 = 0; i < 
‹dî_Àaf
 - 1; i++, j++) {

531 i‡(
i
 =
ö£πi⁄_ödex
) {

533 
j
++;

535 
	`LEAF_KEY
(&
√w_Àaf
, 
j
ËLEAF_KEY(
Àaf
, 
i
);

536 
	`mem˝y
(
	`LEAF_VALUE
(&
√w_Àaf
, 
j
), LEAF_VALUE(
Àaf
, 
i
), 
SIZE_VALUE
);

538 
√w_Àaf
.
num_keys
++;

539 
Àaf
->
num_keys
--;

541 
	`LEAF_KEY
(&
√w_Àaf
, 
ö£πi⁄_ödex
 - 
•lô
Ë
key
;

542 
	`mem˝y
(
	`LEAF_VALUE
(&
√w_Àaf
, 
ö£πi⁄_ödex
 - 
•lô
), 
vÆue
, 
SIZE_VALUE
);

543 
√w_Àaf
.
num_keys
++;

547 
√w_Àaf
.
fûe_off£t
 = 
	`gë_‰ì_∑ge
(
èbÀ_id
);

550 
√w_Àaf
.
siblög
 = 
Àaf
->sibling;

551 
Àaf
->
siblög
 = 
√w_Àaf
.
fûe_off£t
;

554 
i
 = 
Àaf
->
num_keys
; i < 
‹dî_Àaf
 - 1; i++) {

555 
	`LEAF_KEY
(
Àaf
, 
i
) = 0;

556 
	`mem£t
(
	`LEAF_VALUE
(
Àaf
, 
i
), 0, 
SIZE_VALUE
);

558 
i
 = 
√w_Àaf
.
num_keys
; i < 
‹dî_Àaf
 - 1; i++) {

559 
	`LEAF_KEY
(&
√w_Àaf
, 
i
) = 0;

560 
	`mem£t
(
	`LEAF_VALUE
(&
√w_Àaf
, 
i
), 0, 
SIZE_VALUE
);

563 
√w_Àaf
.
∑ª¡
 = 
Àaf
->parent;

565 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
Àaf
);

566 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
√w_Àaf
);

568 
√w_key
 = 
	`LEAF_KEY
(&
√w_Àaf
, 0);

571 
	`ö£π_öto_∑ª¡
(
èbÀ_id
, (
NodePage
*)
Àaf
, 
√w_key
, (NodePage*)&
√w_Àaf
);

572 
	}
}

578 
	$ö£π_öto_node
(
I¡î«lPage
* 
n
, 
À·_ödex
, 
uöt64_t
 
key
, 
off_t
 
right_off£t
) {

579 
i
;

581 
i
 = 
n
->
num_keys
; i > 
À·_ödex
; i--) {

582 
	`INTERNAL_OFFSET
(
n
, 
i
 + 1) = INTERNAL_OFFSET(n, i);

583 
	`INTERNAL_KEY
(
n
, 
i
) = INTERNAL_KEY(n, i - 1);

585 
	`INTERNAL_OFFSET
(
n
, 
À·_ödex
 + 1Ë
right_off£t
;

586 
	`INTERNAL_KEY
(
n
, 
À·_ödex
Ë
key
;

587 
n
->
num_keys
++;

588 
	}
}

594 
	$ö£π_öto_node_a·î_•lôtög
(
èbÀ_id
, 
I¡î«lPage
* 
ﬁd_node
, 
À·_ödex
, 
uöt64_t
 
key
, 
off_t
 
right_off£t
) {

595 
i
, 
j
, 
•lô
, 
k_¥ime
;

596 
uöt64_t
* 
ãmp_keys
;

597 
off_t
* 
ãmp_poöãrs
;

608 
ãmp_poöãrs
 = 
	`mÆloc
–(
‹dî_öã∫Æ
 + 1Ë* (
off_t
) );

609 i‡(
ãmp_poöãrs
 =
NULL
) {

610 
	`≥º‹
("TemporaryÖointersárray for splittingÇodes.");

611 
	`exô
(
EXIT_FAILURE
);

613 
ãmp_keys
 = 
	`mÆloc
–
‹dî_öã∫Æ
 * (
uöt64_t
) );

614 i‡(
ãmp_keys
 =
NULL
) {

615 
	`≥º‹
("Temporary keysárray for splittingÇodes.");

616 
	`exô
(
EXIT_FAILURE
);

619 
i
 = 0, 
j
 = 0; i < 
ﬁd_node
->
num_keys
 + 1; i++, j++) {

620 i‡(
j
 =
À·_ödex
 + 1) j++;

621 
ãmp_poöãrs
[
j
] = 
	`INTERNAL_OFFSET
(
ﬁd_node
, 
i
);

624 
i
 = 0, 
j
 = 0; i < 
ﬁd_node
->
num_keys
; i++, j++) {

625 i‡(
j
 =
À·_ödex
) j++;

626 
ãmp_keys
[
j
] = 
	`INTERNAL_KEY
(
ﬁd_node
, 
i
);

629 
ãmp_poöãrs
[
À·_ödex
 + 1] = 
right_off£t
;

630 
ãmp_keys
[
À·_ödex
] = 
key
;

636 
•lô
 = 
	`cut
(
‹dî_öã∫Æ
);

638 
I¡î«lPage
 
√w_node
;

639 
√w_node
.
num_keys
 = 0;

640 
√w_node
.
is_Àaf
 = 0;

641 
√w_node
.
fûe_off£t
 = 
	`gë_‰ì_∑ge
(
èbÀ_id
);

643 
ﬁd_node
->
num_keys
 = 0;

644 
i
 = 0; i < 
•lô
 - 1; i++) {

645 
	`INTERNAL_OFFSET
(
ﬁd_node
, 
i
Ë
ãmp_poöãrs
[i];

646 
	`INTERNAL_KEY
(
ﬁd_node
, 
i
Ë
ãmp_keys
[i];

647 
ﬁd_node
->
num_keys
++;

649 
	`INTERNAL_OFFSET
(
ﬁd_node
, 
i
Ë
ãmp_poöãrs
[i];

650 
k_¥ime
 = 
ãmp_keys
[
•lô
 - 1];

651 ++
i
, 
j
 = 0; i < 
‹dî_öã∫Æ
; i++, j++) {

652 
	`INTERNAL_OFFSET
(&
√w_node
, 
j
Ë
ãmp_poöãrs
[
i
];

653 
	`INTERNAL_KEY
(&
√w_node
, 
j
Ë
ãmp_keys
[
i
];

654 
√w_node
.
num_keys
++;

656 
	`INTERNAL_OFFSET
(&
√w_node
, 
j
Ë
ãmp_poöãrs
[
i
];

657 
	`‰ì
(
ãmp_poöãrs
);

658 
	`‰ì
(
ãmp_keys
);

659 
√w_node
.
∑ª¡
 = 
ﬁd_node
->parent;

660 
i
 = 0; i <
√w_node
.
num_keys
; i++) {

661 
NodePage
 
chûd_∑ge
;

662 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
	`INTERNAL_OFFSET
(&
√w_node
, 
i
), (
Page
*)&
chûd_∑ge
);

663 
chûd_∑ge
.
∑ª¡
 = 
√w_node
.
fûe_off£t
;

664 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
chûd_∑ge
);

668 
i
 = 
ﬁd_node
->
num_keys
; i < 
‹dî_öã∫Æ
 - 1; i++) {

669 
	`INTERNAL_OFFSET
(
ﬁd_node
, 
i
+1) = 0;

670 
	`INTERNAL_KEY
(
ﬁd_node
, 
i
) = 0;

673 
i
 = 
√w_node
.
num_keys
; i < 
‹dî_öã∫Æ
 - 1; i++) {

674 
	`INTERNAL_OFFSET
(&
√w_node
, 
i
+1) = 0;

675 
	`INTERNAL_KEY
(&
√w_node
, 
i
) = 0;

679 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
√w_node
);

680 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
ﬁd_node
);

686 
	`ö£π_öto_∑ª¡
(
èbÀ_id
, (
NodePage
*)
ﬁd_node
, 
k_¥ime
, (NodePage*)&
√w_node
);

687 
	}
}

692 
	$ö£π_öto_∑ª¡
(
èbÀ_id
, 
NodePage
* 
À·
, 
uöt64_t
 
key
, NodePage* 
right
) {

694 
I¡î«lPage
 
∑ª¡_node
;

697 i‡(
À·
->
∑ª¡
 == 0) {

698 
	`ö£π_öto_√w_roŸ
(
èbÀ_id
, 
À·
, 
key
, 
right
);

702 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
À·
->
∑ª¡
, (
Page
*)&
∑ª¡_node
);

712 
À·_ödex
 = 
	`gë_À·_ödex
(&
∑ª¡_node
, 
À·
->
fûe_off£t
);

717 i‡(
∑ª¡_node
.
num_keys
 < 
‹dî_öã∫Æ
 - 1) {

718 
	`ö£π_öto_node
(&
∑ª¡_node
, 
À·_ödex
, 
key
, 
right
->
fûe_off£t
);

719 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
∑ª¡_node
);

727  
	`ö£π_öto_node_a·î_•lôtög
(
èbÀ_id
, &
∑ª¡_node
, 
À·_ödex
, 
key
, 
right
->
fûe_off£t
);

728 
	}
}

734 
	$ö£π_öto_√w_roŸ
(
èbÀ_id
, 
NodePage
* 
À·
, 
uöt64_t
 
key
, NodePage* 
right
) {

736 
I¡î«lPage
 
roŸ_node
;

737 
	`mem£t
(&
roŸ_node
, 0, (
I¡î«lPage
));

738 
roŸ_node
.
fûe_off£t
 = 
	`gë_‰ì_∑ge
(
èbÀ_id
);

739 
	`INTERNAL_KEY
(&
roŸ_node
, 0Ë
key
;

740 
	`INTERNAL_OFFSET
(&
roŸ_node
, 0Ë
À·
->
fûe_off£t
;

741 
	`INTERNAL_OFFSET
(&
roŸ_node
, 1Ë
right
->
fûe_off£t
;

742 
roŸ_node
.
num_keys
++;

743 
roŸ_node
.
∑ª¡
 = 0;

744 
roŸ_node
.
is_Àaf
 = 0;

745 
À·
->
∑ª¡
 = 
roŸ_node
.
fûe_off£t
;

746 
right
->
∑ª¡
 = 
roŸ_node
.
fûe_off£t
;

748 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
roŸ_node
);

749 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
À·
);

750 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
right
);

752 
dbhódî
[
èbÀ_id
 - 1].
roŸ_off£t
 = 
roŸ_node
.
fûe_off£t
;

753 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)(
dbhódî
 +Åable_id - 1));

754 
	}
}

758 
	$°¨t_√w_åì
(
èbÀ_id
, 
uöt64_t
 
key
, c⁄° * 
vÆue
) {

759 
LófPage
 
roŸ_node
;

761 
off_t
 
roŸ_off£t
 = 
	`gë_‰ì_∑ge
(
èbÀ_id
);

762 
roŸ_node
.
fûe_off£t
 = 
roŸ_off£t
;

764 
roŸ_node
.
∑ª¡
 = 0;

765 
roŸ_node
.
is_Àaf
 = 1;

766 
roŸ_node
.
num_keys
 = 1;

767 
	`LEAF_KEY
(&
roŸ_node
, 0Ë
key
;

768 
roŸ_node
.
siblög
 = 0;

769 
	`mem˝y
(
	`LEAF_VALUE
(&
roŸ_node
, 0), 
vÆue
, 
SIZE_VALUE
);

771 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
roŸ_node
);

773 
dbhódî
[
èbÀ_id
 - 1].
roŸ_off£t
 =Ñoot_offset;

774 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)(
dbhódî
 +Åable_id - 1));

775 
	}
}

783 
	$ö£π
(
èbÀ_id
, 
uöt64_t
 
key
, c⁄° * 
vÆue
) {

787 * 
vÆue_found
 = 
NULL
;

789 i‡((
vÆue_found
 = 
	`föd
(
èbÀ_id
, 
key
)) != 0) {

790 
	`‰ì
(
vÆue_found
);

797 i‡(
dbhódî
[
èbÀ_id
 - 1].
roŸ_off£t
 == 0) {

798 
	`°¨t_√w_åì
(
èbÀ_id
, 
key
, 
vÆue
);

806 
LófPage
 
Àaf_node
;

807 
	`föd_Àaf
(
èbÀ_id
, 
key
, &
Àaf_node
);

812 i‡(
Àaf_node
.
num_keys
 < 
‹dî_Àaf
 - 1) {

813 
	`ö£π_öto_Àaf
(
èbÀ_id
, &
Àaf_node
, 
key
, 
vÆue
);

817 
	`ö£π_öto_Àaf_a·î_•lôtög
(
èbÀ_id
, &
Àaf_node
, 
key
, 
vÆue
);

820 
	}
}

830 
	$gë_√ighb‹_ödex
(
èbÀ_id
, 
NodePage
* 
node_∑ge
) {

832 
i
;

840 
I¡î«lPage
 
∑ª¡_node
;

841 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
node_∑ge
->
∑ª¡
, (
Page
*)&
∑ª¡_node
);

842 
i
 = 0; i <
∑ª¡_node
.
num_keys
; i++)

843 i‡(
	`INTERNAL_OFFSET
(&
∑ª¡_node
, 
i
Ë=
node_∑ge
->
fûe_off£t
)

844  
i
 - 1;

847 
	`as£π
("Search forÇonexistentÖointerÅoÇode inÖarent.");

849 
	}
}

851 
	$ªmove_íåy_‰om_node
(
èbÀ_id
, 
NodePage
* 
node_∑ge
, 
uöt64_t
 
key
) {

853 
i
;

854 
key_idx
 = 0;

856 i‡(
node_∑ge
->
is_Àaf
) {

857 
LófPage
* 
Àaf_node
 = (LófPage*)
node_∑ge
;

860 
i
 = 0; i < 
Àaf_node
->
num_keys
; i++) {

861 i‡(
	`LEAF_KEY
(
Àaf_node
, 
i
Ë=
key
) {

862 
key_idx
 = 
i
;

866 i‡(
i
 =
Àaf_node
->
num_keys
) {

867 
	`as£π
("remove_entry_from_node:Ço key inÅhisÖage");

871 
i
 = 
key_idx
; i < 
Àaf_node
->
num_keys
 - 1; i++) {

872 
	`LEAF_KEY
(
Àaf_node
, 
i
) = LEAF_KEY(leaf_node, i+1);

873 
	`mem˝y
(
	`LEAF_VALUE
(
Àaf_node
, 
i
), LEAF_VALUE÷óf_node, i+1), 
SIZE_VALUE
);

876 
	`LEAF_KEY
(
Àaf_node
,Üóf_node->
num_keys
 - 1) = 0;

877 
	`mem£t
(
	`LEAF_VALUE
(
Àaf_node
,Üóf_node->
num_keys
 - 1), 0, 
SIZE_VALUE
);

879 
Àaf_node
->
num_keys
--;

882 
I¡î«lPage
* 
öã∫Æ_node
 = (I¡î«lPage*)
node_∑ge
;

885 
i
 = 0; i < 
öã∫Æ_node
->
num_keys
; i++) {

886 i‡(
	`INTERNAL_KEY
(
öã∫Æ_node
, 
i
Ë=
key
) {

887 
key_idx
 = 
i
;

891 i‡(
i
 =
öã∫Æ_node
->
num_keys
) {

892 
	`as£π
("remove_entry_from_node:Ço key inÅhisÖage");

896 
i
 = 
key_idx
; i < 
öã∫Æ_node
->
num_keys
 - 1; i++) {

897 
	`INTERNAL_KEY
(
öã∫Æ_node
, 
i
) = INTERNAL_KEY(internal_node, i+1);

898 
	`INTERNAL_OFFSET
(
öã∫Æ_node
, 
i
+1) = INTERNAL_OFFSET(internal_node, i+2);

901 
	`INTERNAL_KEY
(
öã∫Æ_node
, i¡î«l_node->
num_keys
 - 1) = 0;

902 
	`INTERNAL_OFFSET
(
öã∫Æ_node
, i¡î«l_node->
num_keys
) = 0;

904 
öã∫Æ_node
->
num_keys
--;

907 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
node_∑ge
);

908 
	}
}

910 
	$adju°_roŸ
(
èbÀ_id
) {

912 
NodePage
 
roŸ_∑ge
;

913 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
dbhódî
[èbÀ_id - 1].
roŸ_off£t
, (
Page
*)&
roŸ_∑ge
);

920 i‡(
roŸ_∑ge
.
num_keys
 > 0)

930 i‡(!
roŸ_∑ge
.
is_Àaf
) {

931 
I¡î«lPage
* 
roŸ_node
 = (I¡î«lPage*)&
roŸ_∑ge
;

932 
dbhódî
[
èbÀ_id
 - 1].
roŸ_off£t
 = 
	`INTERNAL_OFFSET
(
roŸ_node
, 0);

934 
NodePage
 
node_∑ge
;

935 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
dbhódî
[èbÀ_id - 1].
roŸ_off£t
, (
Page
*)&
node_∑ge
);

936 
node_∑ge
.
∑ª¡
 = 0;

938 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
node_∑ge
);

939 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)(
dbhódî
 +Åable_id - 1));

946 
dbhódî
[
èbÀ_id
 - 1].
roŸ_off£t
 = 0;

947 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)(
dbhódî
 +Åable_id - 1));

950 
	`put_‰ì_∑ge
(
èbÀ_id
, 
roŸ_∑ge
.
fûe_off£t
);

951 
	}
}

959 
	$cﬂÀs˚_nodes
(
èbÀ_id
, 
NodePage
* 
node_∑ge
, NodePage* 
√ighb‹_∑ge
, 
√ighb‹_ödex
, 
k_¥ime
) {

961 
i
, 
j
, 
√ighb‹_ö£πi⁄_ödex
, 
n_íd
;

962 
NodePage
* 
tmp
;

968 i‡(
√ighb‹_ödex
 == -1) {

969 
tmp
 = 
node_∑ge
;

970 
node_∑ge
 = 
√ighb‹_∑ge
;

971 
√ighb‹_∑ge
 = 
tmp
;

980 
√ighb‹_ö£πi⁄_ödex
 = 
√ighb‹_∑ge
->
num_keys
;

987 i‡(!
node_∑ge
->
is_Àaf
) {

988 
I¡î«lPage
* 
node
 = (I¡î«lPage*)
node_∑ge
;

989 
I¡î«lPage
* 
√ighb‹_node
 = (I¡î«lPage*)
√ighb‹_∑ge
;

994 
	`INTERNAL_KEY
(
√ighb‹_node
, 
√ighb‹_ö£πi⁄_ödex
Ë
k_¥ime
;

995 
√ighb‹_node
->
num_keys
++;

997 
n_íd
 = 
node
->
num_keys
;

999 
i
 = 
√ighb‹_ö£πi⁄_ödex
 + 1, 
j
 = 0; j < 
n_íd
; i++, j++) {

1000 
	`INTERNAL_KEY
(
√ighb‹_node
, 
i
ËINTERNAL_KEY(
node
, 
j
);

1001 
	`INTERNAL_OFFSET
(
√ighb‹_node
, 
i
ËINTERNAL_OFFSET(
node
, 
j
);

1002 
√ighb‹_node
->
num_keys
++;

1003 
node
->
num_keys
--;

1010 
	`INTERNAL_OFFSET
(
√ighb‹_node
, 
i
ËINTERNAL_OFFSET(
node
, 
j
);

1015 
i
 = 0; i < 
√ighb‹_node
->
num_keys
 + 1; i++) {

1016 
NodePage
 
chûd_∑ge
;

1017 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
	`INTERNAL_OFFSET
(
√ighb‹_node
, 
i
), (
Page
*)&
chûd_∑ge
);

1018 
chûd_∑ge
.
∑ª¡
 = 
√ighb‹_node
->
fûe_off£t
;

1019 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
chûd_∑ge
);

1022 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
√ighb‹_node
);

1024 
	`put_‰ì_∑ge
(
èbÀ_id
, 
node
->
fûe_off£t
);

1034 
LófPage
* 
node
 = (LófPage*)
node_∑ge
;

1035 
LófPage
* 
√ighb‹_node
 = (LófPage*)
√ighb‹_∑ge
;

1037 
i
 = 
√ighb‹_ö£πi⁄_ödex
, 
j
 = 0; j < 
node
->
num_keys
; i++, j++) {

1038 
	`LEAF_KEY
(
√ighb‹_node
, 
i
ËLEAF_KEY(
node
, 
j
);

1039 
	`mem˝y
(
	`LEAF_VALUE
(
√ighb‹_node
, 
i
), LEAF_VALUE(
node
, 
j
), 
SIZE_VALUE
);

1040 
√ighb‹_node
->
num_keys
++;

1042 
√ighb‹_node
->
siblög
 = 
node
->sibling;

1044 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
√ighb‹_node
);

1046 
	`put_‰ì_∑ge
(
èbÀ_id
, 
node
->
fûe_off£t
);

1049 
NodePage
 
∑ª¡_node
;

1050 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
node_∑ge
->
∑ª¡
, (
Page
*)&
∑ª¡_node
);

1051 
	`dñëe_íåy
(
èbÀ_id
, &
∑ª¡_node
, 
k_¥ime
);

1052 
	}
}

1060 
	$ªdi°ribuã_nodes
(
èbÀ_id
, 
NodePage
* 
node_∑ge
, NodePage* 
√ighb‹_∑ge
,

1061 
√ighb‹_ödex
,

1062 
k_¥ime_ödex
, 
k_¥ime
) {

1064 
i
;

1071 i‡(
√ighb‹_ödex
 != -1) {

1072 i‡(!
node_∑ge
->
is_Àaf
) {

1073 
I¡î«lPage
* 
node
 = (I¡î«lPage*)
node_∑ge
;

1074 
I¡î«lPage
* 
√ighb‹_node
 = (I¡î«lPage*)
√ighb‹_∑ge
;

1075 
	`INTERNAL_OFFSET
(
node
,Çode->
num_keys
 + 1) = INTERNAL_OFFSET(node,Çode->num_keys);

1077 
i
 = 
node
->
num_keys
; i > 0; i--) {

1078 
	`INTERNAL_KEY
(
node
, 
i
) = INTERNAL_KEY(node, i - 1);

1079 
	`INTERNAL_OFFSET
(
node
, 
i
) = INTERNAL_OFFSET(node, i - 1);

1081 
	`INTERNAL_OFFSET
(
node
, 0ËINTERNAL_OFFSET(
√ighb‹_node
,Çeighb‹_node->
num_keys
);

1082 
NodePage
 
chûd_∑ge
;

1083 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
	`INTERNAL_OFFSET
(
node
, 0), (
Page
*)&
chûd_∑ge
);

1084 
chûd_∑ge
.
∑ª¡
 = 
node
->
fûe_off£t
;

1085 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
chûd_∑ge
);

1087 
	`INTERNAL_OFFSET
(
√ighb‹_node
,Çeighb‹_node->
num_keys
) = 0;

1088 
	`INTERNAL_KEY
(
node
, 0Ë
k_¥ime
;

1090 
I¡î«lPage
 
∑ª¡_node
;

1091 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
node
->
∑ª¡
, (
Page
*)&
∑ª¡_node
);

1092 
	`INTERNAL_KEY
(&
∑ª¡_node
, 
k_¥ime_ödex
ËINTERNAL_KEY(
√ighb‹_node
,Çeighb‹_node->
num_keys
 - 1);

1093 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
∑ª¡_node
);

1098 
node
->
num_keys
++;

1099 
√ighb‹_node
->
num_keys
--;

1101 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
node_∑ge
);

1102 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
√ighb‹_∑ge
);

1105 
LófPage
* 
node
 = (LófPage*)
node_∑ge
;

1106 
LófPage
* 
√ighb‹_node
 = (LófPage*)
√ighb‹_∑ge
;

1108 
i
 = 
node
->
num_keys
; i > 0; i--) {

1109 
	`LEAF_KEY
(
node
, 
i
) = LEAF_KEY(node, i - 1);

1110 
	`mem˝y
(
	`LEAF_VALUE
(
node
, 
i
), LEAF_VALUE“ode, i - 1), 
SIZE_VALUE
);

1112 
	`mem˝y
(
	`LEAF_VALUE
(
node
, 0), LEAF_VALUE(
√ighb‹_node
,Çeighb‹_node->
num_keys
 - 1), 
SIZE_VALUE
);

1113 
	`mem£t
(
	`LEAF_VALUE
(
√ighb‹_node
,Çeighb‹_node->
num_keys
 - 1), 0, 
SIZE_VALUE
);

1114 
	`LEAF_KEY
(
node
, 0ËLEAF_KEY(
√ighb‹_node
,Çeighb‹_node->
num_keys
 - 1);

1116 
I¡î«lPage
 
∑ª¡_node
;

1117 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
node
->
∑ª¡
, (
Page
*)&
∑ª¡_node
);

1118 
	`INTERNAL_KEY
(&
∑ª¡_node
, 
k_¥ime_ödex
Ë
	`LEAF_KEY
(
node
, 0);

1119 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
∑ª¡_node
);

1124 
node
->
num_keys
++;

1125 
√ighb‹_node
->
num_keys
--;

1127 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
node_∑ge
);

1128 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
√ighb‹_∑ge
);

1139 i‡(
node_∑ge
->
is_Àaf
) {

1140 
LófPage
* 
node
 = (LófPage*)
node_∑ge
;

1141 
LófPage
* 
√ighb‹_node
 = (LófPage*)
√ighb‹_∑ge
;;

1143 
	`LEAF_KEY
(
node
,Çode->
num_keys
ËLEAF_KEY(
√ighb‹_node
, 0);

1144 
	`mem˝y
(
	`LEAF_VALUE
(
node
,Çode->
num_keys
), LEAF_VALUE(
√ighb‹_node
, 0), 
SIZE_VALUE
);

1146 
I¡î«lPage
 
∑ª¡_node
;

1147 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
node
->
∑ª¡
, (
Page
*)&
∑ª¡_node
);

1148 
	`INTERNAL_KEY
(&
∑ª¡_node
, 
k_¥ime_ödex
Ë
	`LEAF_KEY
(
√ighb‹_node
, 1);

1149 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
∑ª¡_node
);

1151 
i
 = 0; i < 
√ighb‹_node
->
num_keys
 - 1; i++) {

1152 
	`LEAF_KEY
(
√ighb‹_node
, 
i
) = LEAF_KEY(neighbor_node, i + 1);

1153 
	`mem˝y
(
	`LEAF_VALUE
(
√ighb‹_node
, 
i
), LEAF_VALUE“eighb‹_node, i + 1), 
SIZE_VALUE
);

1159 
node
->
num_keys
++;

1160 
√ighb‹_node
->
num_keys
--;

1162 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
node_∑ge
);

1163 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
√ighb‹_∑ge
);

1167 
I¡î«lPage
* 
node
 = (I¡î«lPage*)
node_∑ge
;

1168 
I¡î«lPage
* 
√ighb‹_node
 = (I¡î«lPage*)
√ighb‹_∑ge
;

1170 
	`INTERNAL_KEY
(
node
,Çode->
num_keys
Ë
k_¥ime
;

1171 
	`INTERNAL_OFFSET
(
node
,Çode->
num_keys
 + 1ËINTERNAL_OFFSET(
√ighb‹_node
, 0);

1173 
NodePage
 
chûd_∑ge
;

1174 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
	`INTERNAL_OFFSET
(
node
,Çode->
num_keys
 + 1), (
Page
*)&
chûd_∑ge
);

1175 
chûd_∑ge
.
∑ª¡
 = 
node
->
fûe_off£t
;

1176 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
chûd_∑ge
);

1178 
I¡î«lPage
 
∑ª¡_node
;

1179 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
node
->
∑ª¡
, (
Page
*)&
∑ª¡_node
);

1180 
	`INTERNAL_KEY
(&
∑ª¡_node
, 
k_¥ime_ödex
ËINTERNAL_KEY(
√ighb‹_node
, 0);

1181 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
∑ª¡_node
);

1183 
i
 = 0; i < 
√ighb‹_node
->
num_keys
 - 1; i++) {

1184 
	`INTERNAL_KEY
(
√ighb‹_node
, 
i
) = INTERNAL_KEY(neighbor_node, i + 1);

1185 
	`INTERNAL_OFFSET
(
√ighb‹_node
, 
i
) = INTERNAL_OFFSET(neighbor_node, i + 1);

1188 
	`INTERNAL_OFFSET
(
√ighb‹_node
, 
i
) = INTERNAL_OFFSET(neighbor_node, i + 1);

1195 
node
->
num_keys
++;

1196 
√ighb‹_node
->
num_keys
--;

1198 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
node_∑ge
);

1199 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
√ighb‹_∑ge
);

1203 
	}
}

1211 
	$dñëe_íåy
(
èbÀ_id
, 
NodePage
* 
node_∑ge
, 
uöt64_t
 
key
) {

1213 
mö_keys
;

1214 
off_t
 
√ighb‹_off£t
;

1215 
√ighb‹_ödex
;

1216 
k_¥ime_ödex
, 
k_¥ime
;

1217 
ˇ∑côy
;

1221 
	`ªmove_íåy_‰om_node
(
èbÀ_id
, 
node_∑ge
, 
key
);

1225 i‡(
dbhódî
[
èbÀ_id
 - 1].
roŸ_off£t
 =
node_∑ge
->
fûe_off£t
) {

1226 
	`adju°_roŸ
(
èbÀ_id
);

1238 
mö_keys
 = 
node_∑ge
->
is_Àaf
 ? 
	`cut
(
‹dî_Àaf
 - 1Ë: cut(
‹dî_öã∫Æ
) - 1;

1244 i‡(
node_∑ge
->
num_keys
 >
mö_keys
)

1259 
√ighb‹_ödex
 = 
	`gë_√ighb‹_ödex
(
èbÀ_id
, 
node_∑ge
);

1260 
k_¥ime_ödex
 = 
√ighb‹_ödex
 == -1 ? 0 :Çeighbor_index;

1262 
I¡î«lPage
 
∑ª¡_node
;

1263 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
node_∑ge
->
∑ª¡
, (
Page
*)&
∑ª¡_node
);

1265 
k_¥ime
 = 
	`INTERNAL_KEY
(&
∑ª¡_node
, 
k_¥ime_ödex
);

1266 
√ighb‹_off£t
 = 
√ighb‹_ödex
 =-1 ? 
	`INTERNAL_OFFSET
(&
∑ª¡_node
, 1) :

1267 
	`INTERNAL_OFFSET
(&
∑ª¡_node
, 
√ighb‹_ödex
);

1269 
ˇ∑côy
 = 
node_∑ge
->
is_Àaf
 ? 
‹dî_Àaf
 : 
‹dî_öã∫Æ
 - 1;

1271 
NodePage
 
√ighb‹_∑ge
;

1272 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
√ighb‹_off£t
, (
Page
*)&
√ighb‹_∑ge
);

1275 i‡(
√ighb‹_∑ge
.
num_keys
 + 
node_∑ge
->num_key†< 
ˇ∑côy
)

1276 
	`cﬂÀs˚_nodes
(
èbÀ_id
, 
node_∑ge
, &
√ighb‹_∑ge
, 
√ighb‹_ödex
, 
k_¥ime
);

1281 
	`ªdi°ribuã_nodes
(
èbÀ_id
, 
node_∑ge
, &
√ighb‹_∑ge
, 
√ighb‹_ödex
, 
k_¥ime_ödex
, 
k_¥ime
);

1284 
	}
}

1288 
	$dñëe
(
èbÀ_id
, 
uöt64_t
 
key
) {

1290 * 
vÆue_found
 = 
NULL
;

1291 i‡((
vÆue_found
 = 
	`föd
(
èbÀ_id
, 
key
)) == 0) {

1293 
	`‰ì
(
vÆue_found
);

1297 
LófPage
 
Àaf_node
;

1298 
	`föd_Àaf
(
èbÀ_id
, 
key
, &
Àaf_node
);

1300 
	`dñëe_íåy
(
èbÀ_id
, (
NodePage
*)&
Àaf_node
, 
key
);

1303 
	}
}

1306 
	$öô_db
(
num_buf
){

1307 
i
;

1309 
buf_mgr
 = (
Buf„r
 *)
	`ˇŒoc
(
num_buf
, (Buffer));

1311 
i
 = 0; i < 
num_buf
; i++){

1312 
buf_mgr
[
i
].
‰ame
 = (
Page
*)
	`mÆloc
((Page));

1315 if(
buf_mgr
 =
NULL
){

1322 
buf_size
 = 
num_buf
;

1325 
	}
}

1327 
	$˛o£_èbÀ
(
èbÀ_id
){

1328 
i
;

1331 if(
èbÀ_id
 < 1 ||ÅabÀ_id > 10 || 
buf_size
 =-1 || 
buf_mgr
 =
NULL
){

1335 
i
 = 0; i < 
buf_size
; i++){

1336 if(
buf_mgr
[
i
].
èbÀ_id
 ==Åable_id){

1338 if(
buf_mgr
[
i
].
is_dúty
 == 1){

1339 
	`Êush_∑ge
(
èbÀ_id
, 
buf_mgr
[
i
].
‰ame
);

1342 
	`mem£t
(
buf_mgr
[
i
].
‰ame
, 0, (
Page
));

1343 
buf_mgr
[
i
].
èbÀ_id
 = 0;

1344 
buf_mgr
[
i
].
∑ge_off£t
 = 0;

1345 
buf_mgr
[
i
].
is_dúty
 = 0;

1346 
buf_mgr
[
i
].
ªfbô
 = 0;

1351 
èbÀ_ids
[
èbÀ_id
 -1] = 0;

1354 
	`˛o£_db
(
èbÀ_id
);

1357 
	}
}

1359 
	$shutdown_db
(){

1360 
i
,
èbÀ_id
 = -1;

1363 if(
buf_size
 =-1 || 
buf_mgr
 =
NULL
){

1367 
i
 = 0; i < 
buf_size
; i++){

1369 if(
buf_mgr
[
i
].
is_dúty
 == 1){

1370 
èbÀ_id
 = 
buf_mgr
[
i
].table_id;

1371 
	`Êush_∑ge
(
èbÀ_id
, 
buf_mgr
[
i
].
‰ame
);

1374 if(1 <
buf_mgr
[
i
].
èbÀ_id
 && buf_mgr[i].table_id <= 10){

1375 
	`‰ì
(
buf_mgr
[
i
].
‰ame
);

1380 
	`‰ì
(
buf_mgr
);

1383 
	}
}

1385 
	$lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
off_t
 
off£t
, 
Page
* 
∑ge
){

1386 
Page
 *
ãmp
;

1387 
buf_ödex
 = -1;

1389 
ãmp
 = 
	`check_buf„r_f‹_lﬂd
(
èbÀ_id
, 
off£t
);

1392 if(
ãmp
 !
NULL
){

1394 
	`mem˝y
(
∑ge
, 
ãmp
, (
Page
));

1395 
∑ge
->
fûe_off£t
 = 
off£t
;

1402 
buf_ödex
 = 
	`ª∂a˚_∑ge
(
NULL
);

1405 
	`lﬂd_∑ge
(
èbÀ_id
, 
off£t
, 
∑ge
);

1406 
∑ge
->
fûe_off£t
 = 
off£t
;

1413 
	`mem˝y
(
buf_mgr
[
buf_ödex
].
‰ame
, 
∑ge
, (
Page
));

1414 
buf_mgr
[
buf_ödex
].
èbÀ_id
 =Åable_id;

1415 
buf_mgr
[
buf_ödex
].
∑ge_off£t
 = 
off£t
;

1416 
buf_mgr
[
buf_ödex
].
is_dúty
 = 0;

1417 
buf_mgr
[
buf_ödex
].
ªfbô
 = 1;

1419 
	}
}

1420 
Page
* 
	$check_buf„r_f‹_lﬂd
(
èbÀ_id
, 
off_t
 
off£t
){

1421 
i
;

1423 if(
buf_size
 == -1){

1425  
NULL
;

1428 
i
 = 0; i < 
buf_size
; i++){

1429 if(
buf_mgr
[
èrgë_buf
].
èbÀ_id
 =èbÀ_id && buf_mgr[èrgë_buf].
∑ge_off£t
 =
off£t
){

1431 
buf_mgr
[
èrgë_buf
].
ªfbô
 = 1;

1433  
buf_mgr
[
èrgë_buf
].
‰ame
;

1435 
èrgë_buf
 = (èrgë_bu‡+ 1Ë% 
buf_size
;

1439  
NULL
;

1440 
	}
}

1441 
	$check_buf„r_f‹_Êush
(
èbÀ_id
, 
off_t
 
off£t
){

1442 
i
;

1444 if(
buf_size
 == -1){

1449 
i
 = 0; i < 
buf_size
; i++){

1450 if(
buf_mgr
[
èrgë_buf
].
èbÀ_id
 =èbÀ_id && buf_mgr[èrgë_buf].
∑ge_off£t
 =
off£t
){

1452 
buf_mgr
[
èrgë_buf
].
ªfbô
 = 1;

1454  
èrgë_buf
;

1456 
èrgë_buf
 = (èrgë_bu‡+ 1Ë% 
buf_size
;

1461 
	}
}

1463 
	$ª∂a˚_∑ge
(
FILE
 *
fûe
){

1465 
èrgë_ödex
 = -1;

1468 
èrgë_ödex
 == -1){

1471 if(
buf_mgr
[
˛ock_h™d
].
ªfbô
 == 0){

1473 
èrgë_ödex
 = 
˛ock_h™d
;

1476 if(
buf_mgr
[
˛ock_h™d
].
èbÀ_id
 == -1){

1477 
i
;

1478 
OuçutPage
 *
èrgë
;

1480 
	`mem˝y
((
Page
 *)
èrgë
, 
buf_mgr
[
˛ock_h™d
].
‰ame
, (Page));

1482 
i
 = 0; i < 
èrgë
->
fûe_off£t
; i++){

1483 
	`Ârötf
(
fûe
, "%" 
PRIu64
 ",%s," "%" PRIu64 ",%s\n", 
	`RESULT_KEY1
(
èrgë
, 
i
), 
	`RESULT_VALUE1
—¨gë, i), 
	`RESULT_KEY2
—¨gë, i), 
	`RESULT_VALUE2
(target, i) );

1486 
buf_mgr
[
˛ock_h™d
].
is_dúty
 = 0;

1490 if(
buf_mgr
[
˛ock_h™d
].
is_dúty
 == 1){

1492 
	`Êush_∑ge
(
buf_mgr
[
˛ock_h™d
].
èbÀ_id
, buf_mgr[˛ock_h™d].
‰ame
);

1495 
	`mem£t
(
buf_mgr
[
˛ock_h™d
].
‰ame
, 0, (
Page
));

1496 
buf_mgr
[
˛ock_h™d
].
èbÀ_id
 = 0;

1497 
buf_mgr
[
˛ock_h™d
].
∑ge_off£t
 = 0;

1498 
buf_mgr
[
˛ock_h™d
].
is_dúty
 = 0;

1499 
buf_mgr
[
˛ock_h™d
].
ªfbô
 = 0;

1505 if(
buf_mgr
[
˛ock_h™d
].
ªfbô
 == 1){

1506 
buf_mgr
[
˛ock_h™d
].
ªfbô
 = 0;

1510 
˛ock_h™d
 = (˛ock_h™d + 1Ë% 
buf_size
;

1514  
èrgë_ödex
;

1515 
	}
}

1518 
	$Êush_∑ge_to_buf„r
(
èbÀ_id
, 
Page
 *
∑ge
){

1519 
i
, 
buf_ödex
 = -1, 
ödex
 = -1;

1524 
ödex
 = 
	`check_buf„r_f‹_Êush
(
èbÀ_id
, 
∑ge
->
fûe_off£t
);

1527 if(
ödex
 != -1){

1528 
	`mem˝y
(
buf_mgr
[
èrgë_buf
].
‰ame
, 
∑ge
, (
Page
));

1529 
buf_mgr
[
èrgë_buf
].
is_dúty
 = 1;

1534 
buf_ödex
 = 
	`ª∂a˚_∑ge
(
NULL
);

1538 
	`mem˝y
(
buf_mgr
[
buf_ödex
].
‰ame
, 
∑ge
, (
Page
));

1539 
buf_mgr
[
buf_ödex
].
èbÀ_id
 =Åable_id;

1540 
buf_mgr
[
buf_ödex
].
∑ge_off£t
 = 
∑ge
->
fûe_off£t
;

1542 
buf_mgr
[
buf_ödex
].
is_dúty
 = 1;

1543 
buf_mgr
[
buf_ödex
].
ªfbô
 = 1;

1545 
	}
}

1550 
	$joö_èbÀ
(
èbÀ_id_1
, 
èbÀ_id_2
, *
∑th«me
){

1551 
FILE
 *
r_Â
;

1552 
uöt64_t
 
num_1
 = -1, 
num_2
 = -1, 
mö_1
 = -1, 
mö_2
 = -1, 
max_1
 = -1, 
max_2
 = -1;

1553 
LófPage
 
Àaf_1
, 
Àaf_2
;

1554 
off_t
 
comp_sib_1
, 
comp_sib_2
;

1555 
comp_num_1
, 
comp_num_2
;

1556 
uöt64_t
 
comp_key_1
, 
comp_key_2
;

1559 if((
r_Â
 = 
	`f›í
(
∑th«me
, "wt")Ë=
NULL
){

1564 
	`èbÀ_öfo
(
èbÀ_id_1
, &
num_1
, &
mö_1
, &
max_1
);

1565 
	`èbÀ_öfo
(
èbÀ_id_2
, &
num_2
, &
mö_2
, &
max_2
);

1573 if(
max_1
 < 
mö_2
 || 
mö_1
 > 
max_2
){

1575 
	`f˛o£
(
r_Â
);

1586 if(
mö_1
 < 
mö_2
){

1589 
	`föd_Àaf
(
èbÀ_id_1
, 
mö_2
, &
Àaf_1
);

1590 
	`föd_Àaf
(
èbÀ_id_2
, 
mö_2
, &
Àaf_2
);

1596 
	`föd_Àaf
(
èbÀ_id_1
, 
mö_1
, &
Àaf_1
);

1597 
	`föd_Àaf
(
èbÀ_id_2
, 
mö_1
, &
Àaf_2
);

1601 
comp_sib_1
 = 
Àaf_1
.
siblög
;

1602 
comp_sib_2
 = 
Àaf_2
.
siblög
;

1603 
comp_num_1
 = 0;

1604 
comp_num_2
 = 0;

1611 (
comp_sib_1
 !0 || 
comp_num_1
 !
Àaf_1
.
num_keys
Ë&& (
comp_sib_2
 !0 || 
comp_num_2
 !
Àaf_2
.num_keys)){

1613 
comp_key_1
 = 
	`LEAF_KEY
(&
Àaf_1
, 
comp_num_1
);

1614 
comp_key_2
 = 
	`LEAF_KEY
(&
Àaf_2
, 
comp_num_2
);

1617 
comp_key_1
 < 
comp_key_2
){

1619 
comp_num_1
++;

1622 if((
comp_num_1
 =
Àaf_1
.
num_keys
Ë&& (
comp_sib_1
 != 0)){

1624 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id_1
, 
comp_sib_1
, (
Page
*)&
Àaf_1
);

1627 
comp_sib_1
 = 
Àaf_1
.
siblög
;

1630 
comp_num_1
 = 0;

1634 if(
comp_sib_1
 =0 && 
comp_num_1
 =
Àaf_1
.
num_keys
){

1635 
	`sync_buf„r
(
r_Â
);

1636 
	`f˛o£
(
r_Â
);

1641 
comp_key_1
 = 
	`LEAF_KEY
(&
Àaf_1
, 
comp_num_1
);

1643 
comp_key_1
 > 
comp_key_2
){

1645 
comp_num_2
++;

1648 if((
comp_num_2
 =
Àaf_2
.
num_keys
Ë&& (
comp_sib_2
 != 0)){

1650 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id_2
, 
comp_sib_2
, (
Page
*)&
Àaf_2
);

1653 
comp_sib_2
 = 
Àaf_2
.
siblög
;

1656 
comp_num_2
 = 0;

1660 if(
comp_sib_1
 =0 && 
comp_num_1
 =
Àaf_1
.
num_keys
){

1661 
	`sync_buf„r
(
r_Â
);

1662 
	`f˛o£
(
r_Â
);

1667 
comp_key_2
 = 
	`LEAF_KEY
(&
Àaf_2
, 
comp_num_2
);

1670 if(
comp_key_1
 =
comp_key_2
){

1673 
	`wrôe_ouçut_buf„r
(
r_Â
, 
comp_key_1
, 
	`LEAF_VALUE
(&
Àaf_1
, 
comp_num_1
), 
comp_key_2
, LEAF_VALUE(&
Àaf_2
, 
comp_num_2
));

1677 
comp_num_1
++;

1678 
comp_num_2
++;

1681 if((
comp_num_1
 =
Àaf_1
.
num_keys
Ë&& (
comp_sib_1
 != 0)){

1683 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id_1
, 
comp_sib_1
, (
Page
*)&
Àaf_1
);

1686 
comp_sib_1
 = 
Àaf_1
.
siblög
;

1689 
comp_num_1
 = 0;

1693 if((
comp_num_2
 =
Àaf_2
.
num_keys
Ë&& (
comp_sib_2
 != 0)){

1695 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id_2
, 
comp_sib_2
, (
Page
*)&
Àaf_2
);

1698 
comp_sib_2
 = 
Àaf_2
.
siblög
;

1701 
comp_num_2
 = 0;

1707 
	`sync_buf„r
(
r_Â
);

1708 
	`f˛o£
(
r_Â
);

1710 
	}
}

1711 
	$èbÀ_öfo
(
èbÀ_id
, 
uöt64_t
 *
num_keys
, uöt64_à*
mö_key
, uöt64_à*
max_key
){

1712 
HódîPage
 
ãmp_hódî
;

1713 
NodePage
 
∑ge
;

1714 
LófPage
 *
ãmp_Àaf
;

1715 
off_t
 
ãmp_siblög
;

1718 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 0, (
Page
*)(&
ãmp_hódî
));

1721 if(
ãmp_hódî
.
roŸ_off£t
 == 0){

1722 *
num_keys
 = 0;

1723 *
max_key
 = 0;

1729 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
ãmp_hódî
.
roŸ_off£t
, (
Page
*)&
∑ge
);

1732 !
∑ge
.
is_Àaf
){

1733 
I¡î«lPage
* 
öã∫Æ_node
 = (I¡î«lPage*)&
∑ge
;

1735 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
	`INTERNAL_OFFSET
(
öã∫Æ_node
, 0), (
Page
*)&
∑ge
);

1742 
ãmp_Àaf
 = (
LófPage
 *)&
∑ge
;

1744 *
num_keys
 = 
ãmp_Àaf
->num_keys;

1745 *
mö_key
 = 
	`LEAF_KEY
(
ãmp_Àaf
, 0);

1746 *
max_key
 = 
	`LEAF_KEY
(
ãmp_Àaf
,Åemp_Àaf->
num_keys
 - 1);

1747 
ãmp_siblög
 = 
ãmp_Àaf
->
siblög
;

1749 
ãmp_siblög
 != 0){

1751 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
ãmp_siblög
, (
Page
*)
ãmp_Àaf
);

1753 *
num_keys
 +
ãmp_Àaf
->num_keys;

1754 *
max_key
 = 
	`LEAF_KEY
(
ãmp_Àaf
,Åemp_Àaf->
num_keys
 - 1);

1755 
ãmp_siblög
 = 
ãmp_Àaf
->
siblög
;

1758 
	}
}

1759 
	$wrôe_ouçut_buf„r
(
FILE
 *
fûe
, 
uöt64_t
 
key1
, *
vÆue1
, uöt64_à
key2
, *
vÆue2
){

1760 
OuçutPage
 
ouçut
;

1763 if(
	`lﬂd_ouçut_∑ge
((
Page
*)&
ouçut
) == -1){

1764 
ouçut
.
ªsu…s
[0].
key1
 = key1;

1765 
	`°r˝y
(
ouçut
.
ªsu…s
[0].
vÆue1
, value1);

1766 
ouçut
.
ªsu…s
[0].
key2
 = key2;

1767 
	`°r˝y
(
ouçut
.
ªsu…s
[0].
vÆue2
, value2);

1768 
ouçut
.
fûe_off£t
 = 1;

1773 if(
ouçut
.
fûe_off£t
 < 
OUTPUT_ORDER
){

1774 
	`RESULT_KEY1
(&
ouçut
, ouçut.
fûe_off£t
Ë
key1
;

1775 
	`°r˝y
(
	`RESULT_VALUE1
(&
ouçut
, ouçut.
fûe_off£t
), 
vÆue1
);

1776 
	`RESULT_KEY2
(&
ouçut
, ouçut.
fûe_off£t
Ë
key2
;

1777 
	`°r˝y
(
	`RESULT_VALUE2
(&
ouçut
, ouçut.
fûe_off£t
), 
vÆue2
);

1779 
ouçut
.
fûe_off£t
++;

1783 
OuçutPage
 
√w
;

1785 
	`sync_buf„r
(
fûe
);

1787 
√w
.
ªsu…s
[0].
key1
 = key1;

1788 
	`°r˝y
(
√w
.
ªsu…s
[0].
vÆue1
, value1);

1789 
√w
.
ªsu…s
[0].
key2
 = key2;

1790 
	`°r˝y
(
√w
.
ªsu…s
[0].
vÆue2
, value2);

1791 
√w
.
fûe_off£t
 = 1;

1793 
	`Êush_ouçut_∑ge
(
fûe
, (
Page
 *)&
√w
);

1798 
	`Êush_ouçut_∑ge
(
fûe
, (
Page
 *)&
ouçut
);

1799 
	}
}

1800 
	$lﬂd_ouçut_∑ge
(
Page
 *
∑ge
){

1801 
Page
 *
ãmp
;

1803 
ãmp
 = 
	`check_buf„r_f‹_lﬂd
(-1, 0);

1806 if(
ãmp
 !
NULL
){

1808 
	`mem˝y
(
∑ge
, 
ãmp
, (
Page
));

1818 
	}
}

1819 
	$Êush_ouçut_∑ge
(
FILE
 *
fûe
, 
Page
 *
∑ge
){

1820 
i
, 
buf_ödex
 = -1, 
ödex
 = -1;

1825 
ödex
 = 
	`check_buf„r_f‹_Êush
(-1, 0);

1828 if(
ödex
 != -1){

1829 
	`mem˝y
(
buf_mgr
[
èrgë_buf
].
‰ame
, 
∑ge
, (
Page
));

1830 
buf_mgr
[
èrgë_buf
].
is_dúty
 = 1;

1835 
buf_ödex
 = 
	`ª∂a˚_∑ge
(
fûe
);

1839 
	`mem˝y
(
buf_mgr
[
buf_ödex
].
‰ame
, 
∑ge
, (
Page
));

1840 
buf_mgr
[
buf_ödex
].
èbÀ_id
 = -1;

1841 
buf_mgr
[
buf_ödex
].
∑ge_off£t
 = 0;

1843 
buf_mgr
[
buf_ödex
].
is_dúty
 = 1;

1844 
buf_mgr
[
buf_ödex
].
ªfbô
 = 1;

1846 
	}
}

1847 
	$sync_buf„r
(
FILE
 *
fûe
){

1848 
i
, 
ödex
, 
íd
;

1849 
OuçutPage
 
èrgë
;

1851 
ödex
 = 
	`check_buf„r_f‹_Êush
(-1, 0);

1853 
	`mem˝y
((
Page
 *)&
èrgë
, 
buf_mgr
[
ödex
].
‰ame
, (Page));

1854 
i
 = 0; i < 
èrgë
.
fûe_off£t
; i++){

1855 
	`Ârötf
(
fûe
, "%" 
PRIu64
 ",%s," "%" PRIu64 ",%s\n", 
	`RESULT_KEY1
(&
èrgë
, 
i
), 
	`RESULT_VALUE1
(&èrgë, i), 
	`RESULT_KEY2
(&èrgë, i), 
	`RESULT_VALUE2
(&target, i) );

1859 
	`mem£t
(
buf_mgr
[
ödex
].
‰ame
, 0, (
Page
));

1860 
buf_mgr
[
ödex
].
èbÀ_id
 = 0;

1861 
buf_mgr
[
ödex
].
∑ge_off£t
 = 0;

1862 
buf_mgr
[
ödex
].
is_dúty
 = 0;

1863 
buf_mgr
[
ödex
].
ªfbô
 = 0;

1864 
	}
}

1867 
	$begö_å™ß˘i⁄
(){

1869 
	}
}

1871 
	$commô_å™ß˘i⁄
(){

1873 
	}
}

1875 
	$ab‹t_å™ß˘i⁄
(){

1877 
	}
}

1878 
	$upd©e
(
èbÀ_id
, 
öt64_t
 
key
, *
vÆue
){

1879 if(
	`föd
(
èbÀ_id
, 
key
Ë=
NULL
 || 
dbhódî
[èbÀ_id -1].
roŸ_off£t
 == 0){

1885 
LófPage
 
Àaf_node
;

1886 
fix_poöt
 = 0;

1888 
	`föd_Àaf
(
èbÀ_id
, 
key
, &
Àaf_node
);

1890 
fix_poöt
 < 
Àaf_node
->
num_keys
 && 
	`LEAF_KEY
÷óf_node, fix_poötË!
key
){

1891 
fix_poöt
++;

1894 
	`mem˝y
(
	`LEAF_VALUE
(
Àaf_node
, 
fix_poöt
), 
vÆue
, 
SIZE_VALUE
);

1897 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)
Àaf_node
);

1901 
	}
}

	@src/file.c

1 
	~<sys/ty≥s.h
>

2 
	~<f˙é.h
>

3 
	~<°dlib.h
>

4 
	~<as£π.h
>

5 
	~<°dio.h
>

6 
	~<uni°d.h
>

7 
	~<°rög.h
>

8 
	~"fûe.h
"

10 
HódîPage
 
	gdbhódî
[10];

11 
	gdbfûe
[10] = {0,};

15 
off_t
 
	$gë_‰ì_∑ge
(
èbÀ_id
) {

16 
off_t
 
‰ì∑ge_off£t
;

18 
‰ì∑ge_off£t
 = 
dbhódî
[
èbÀ_id
 - 1].
‰ìli°
;

19 i‡(
‰ì∑ge_off£t
 == 0) {

21 
	`ex∑nd_fûe
(
èbÀ_id
, 
dbhódî
[èbÀ_id - 1].
num_∑ges
);

22 
‰ì∑ge_off£t
 = 
dbhódî
[
èbÀ_id
 - 1].
‰ìli°
;

25 
FªePage
 
‰ì∑ge
;

26 
	`lﬂd_∑ge_‰om_buf„r
(
èbÀ_id
, 
‰ì∑ge_off£t
, (
Page
*)&
‰ì∑ge
);

27 
dbhódî
[
èbÀ_id
 - 1].
‰ìli°
 = 
‰ì∑ge
.
√xt
;

29 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)(
dbhódî
 +Åable_id - 1));

31  
‰ì∑ge_off£t
;

32 
	}
}

35 
	$put_‰ì_∑ge
(
èbÀ_id
, 
off_t
 
∑ge_off£t
) {

36 
FªePage
 
‰ì∑ge
;

37 
	`mem£t
(&
‰ì∑ge
, 0, 
PAGE_SIZE
);

39 
‰ì∑ge
.
√xt
 = 
dbhódî
[
èbÀ_id
 - 1].
‰ìli°
;

40 
‰ì∑ge
.
fûe_off£t
 = 
∑ge_off£t
;

42 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)&
‰ì∑ge
);

44 
dbhódî
[
èbÀ_id
 - 1].
‰ìli°
 = 
∑ge_off£t
;

46 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)(
dbhódî
 +Åable_id - 1));

47 
	}
}

50 
	$ex∑nd_fûe
(
èbÀ_id
, 
size_t
 
˙t_∑ge_to_ex∑nd
) {

51 
off_t
 
off£t
 = 
dbhódî
[
èbÀ_id
 - 1].
num_∑ges
 * 
PAGE_SIZE
;

53 i‡(
dbhódî
[
èbÀ_id
 - 1].
num_∑ges
 > 1024 * 1024) {

55 
	`as£π
("Test: youáreálready havingá DB file overÅhan 4GB");

58 
i
;

59 
i
 = 0; i < 
˙t_∑ge_to_ex∑nd
; i++) {

60 
	`put_‰ì_∑ge
(
èbÀ_id
, 
off£t
);

61 
dbhódî
[
èbÀ_id
 - 1].
num_∑ges
++;

62 
off£t
 +
PAGE_SIZE
;

65 
	`Êush_∑ge_to_buf„r
(
èbÀ_id
, (
Page
*)(
dbhódî
 +Åable_id - 1));

66 
	}
}

68 
	$lﬂd_∑ge
(
èbÀ_id
, 
off_t
 
off£t
, 
Page
* 
∑ge
) {

69 
	`l£ek
(
dbfûe
[
èbÀ_id
 - 1], 
off£t
, 
SEEK_SET
);

70 
	`ªad
(
dbfûe
[
èbÀ_id
 - 1], 
∑ge
, 
PAGE_SIZE
);

71 
∑ge
->
fûe_off£t
 = 
off£t
;

72 
	}
}

74 
	$Êush_∑ge
(
èbÀ_id
, 
Page
* 
∑ge
) {

75 
	`l£ek
(
dbfûe
[
èbÀ_id
 - 1], 
∑ge
->
fûe_off£t
, 
SEEK_SET
);

76 
	`wrôe
(
dbfûe
[
èbÀ_id
 - 1], 
∑ge
, 
PAGE_SIZE
);

77 
	}
}

	@src/main.c

1 
	~<°dio.h
>

2 
	~<°dlib.h
>

3 
	~<f˙é.h
>

4 
	~<uni°d.h
>

5 
	~<sys/ty≥s.h
>

6 
	~<öây≥s.h
>

7 
	~"b±.h
"

8 
	~"fûe.h
"

9 
	~<°rög.h
>

10 
	~<time.h
>

13 
	$maö
–
¨gc
, ** 
¨gv
 ) {

14 
öput_vÆue_1
[
SIZE_VALUE
], 
öput_vÆue_2
[SIZE_VALUE];

15 
uöt64_t
 
°¨t
, 
íd
, 
jump
;

16 
èbÀ_1
 = 0, 
èbÀ_2
 = 0, 
èbÀ_10
 = 0;

17 
time_t
 
°¨t_t
, 
íd_t
;

19 
	`¥ötf
("WelcomeÅoÑecoveryÅest\n");

21 
	`öô_db
(5);

23 
èbÀ_1
 = 
	`›í_èbÀ
("DATA1");

24 
èbÀ_2
 = 
	`›í_èbÀ
("DATA2");

26 
	`˛o£_èbÀ
(
èbÀ_1
);

27 
	`˛o£_èbÀ
(
èbÀ_2
);

28 
	`˛o£_èbÀ
(
èbÀ_10
);

31 
	`ªmove
("DATA1");

32 
	`ªmove
("DATA2");

34  
EXIT_SUCCESS
;

35 
	}
}

	@
1
.
0
5
61
include/bpt.h
include/file.h
src/bpt.c
src/file.c
src/main.c
