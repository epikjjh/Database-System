cscope 15 $HOME/mysql/Lab/project_final -q 0000000323 0000049223
	@include/bpt.h

1 #iâdeà
__BPT_H__


2 
	#__BPT_H__


	)

4 
İ’_bË
(cÚ¡ * 
f’ame
);

5 * 
fšd
(
bË_id
, 
ušt64_t
 
key
);

6 
š£¹
(
bË_id
, 
ušt64_t
 
key
, cÚ¡ * 
v®ue
);

7 
d–‘e
(
bË_id
, 
ušt64_t
 
key
);

9 
´št_Œ“
(
bË_id
);

13 
š™_db
(
num_buf
);

15 
şo£_bË
(
bË_id
);

17 
shutdown_db
();

	@include/file.h

1 
	~<¡ddef.h
>

2 
	~<š‰y³s.h
>

4 
	#BPTREE_INTERNAL_ORDER
 249

5 
	#BPTREE_LEAF_ORDER
 32

6 

	)

7 
	#PAGE_SIZE
 4096

	)

9 
	#SIZE_KEY
 8

	)

10 
	#SIZE_VALUE
 120

	)

11 
	#SIZE_RECORD
 (
SIZE_KEY
 + 
SIZE_VALUE
)

	)

13 
	#BPTREE_MAX_NODE
 (1024 * 1024)

14 

	)

15 
	#OUTPUT_ORDER
 16

	)

16 
	#SIZE_LOG
 280

	)

28 
	s_RecÜd
 {

29 
ušt64_t
 
	mkey
;

30 
	mv®ue
[
SIZE_VALUE
];

31 } 
	tRecÜd
;

33 
	s_IÁ”ÇlRecÜd
 {

34 
ušt64_t
 
	mkey
;

35 
off_t
 
	moff£t
;

36 } 
	tIÁ”ÇlRecÜd
;

39 
	s_ResuÉ
 {

40 
ušt64_t
 
	mkey1
;

41 
	mv®ue1
[
SIZE_VALUE
];

42 
ušt64_t
 
	mkey2
;

43 
	mv®ue2
[
SIZE_VALUE
];

44 } 
	tResuÉ
;

46 
	s_Page
 {

47 
	mby‹s
[
PAGE_SIZE
];

50 
off_t
 
	mfe_off£t
;

51 } 
	tPage
;

53 
	s_F»ePage
 {

54 
off_t
 
	mÃxt
;

55 
	m»£rved
[
PAGE_SIZE
 - 8];

58 
off_t
 
	mfe_off£t
;

59 } 
	tF»ePage
;

61 
	s_H—d”Page
 {

62 
off_t
 
	mä“li¡
;

63 
off_t
 
	mroÙ_off£t
;

64 
ušt64_t
 
	mnum_·ges
;

65 
off_t
 
	m·ge_l¢
;

66 
	m»£rved
[
PAGE_SIZE
 - 32];

69 
off_t
 
	mfe_off£t
;

70 } 
	tH—d”Page
;

72 
	#INTERNAL_KEY
(
n
, 
i
è(Ò)->
œecÜds
[(i)+1].
key
)

	)

73 
	#INTERNAL_OFFSET
(
n
, 
i
è(Ò)->
œecÜds
[(i)].
off£t
)

	)

74 
	s_IÁ”ÇlPage
 {

77 
off_t
 
	m·»Á
;

78 
	mis_Ëaf
;

79 
	mnum_keys
;

80 
	m»£rved_1
[8];

81 
off_t
 
	m·ge_l¢
;

82 
	m»£rved_2
[112 - 32];

83 
IÁ”ÇlRecÜd
 
	mœecÜds
[
BPTREE_INTERNAL_ORDER
];

85 
	m¥aû
[
PAGE_SIZE
];

88 
off_t
 
	mfe_off£t
;

89 } 
	tIÁ”ÇlPage
;

91 
	#LEAF_KEY
(
n
, 
i
è(Ò)->
»cÜds
[(i)].
key
)

	)

92 
	#LEAF_VALUE
(
n
, 
i
è(Ò)->
»cÜds
[(i)].
v®ue
)

	)

93 
	s_L—fPage
 {

96 
off_t
 
	m·»Á
;

97 
	mis_Ëaf
;

98 
	mnum_keys
;

99 
	m»£rved_1
[8];

100 
off_t
 
	m·ge_l¢
;

101 
	m»£rved_2
[120 - 32];

102 
off_t
 
	msiblšg
;

103 
RecÜd
 
	m»cÜds
[
BPTREE_LEAF_ORDER
-1];

105 
	m¥aû
[
PAGE_SIZE
];

109 
off_t
 
	mfe_off£t
;

110 } 
	tL—fPage
;

112 
	s_NodePage
 {

115 
off_t
 
	m·»Á
;

116 
	mis_Ëaf
;

117 
	mnum_keys
;

118 
	m»£rved_1
[8];

119 
off_t
 
	m·ge_l¢
;

121 
	m¥aû
[
PAGE_SIZE
];

125 
off_t
 
	mfe_off£t
;

126 } 
	tNodePage
;

129 
	#RESULT_KEY1
(
n
, 
i
è(Ò)->
»suÉs
[(i)].
key1
)

	)

130 
	#RESULT_VALUE1
(
n
, 
i
è(Ò)->
»suÉs
[(i)].
v®ue1
)

	)

131 
	#RESULT_KEY2
(
n
, 
i
è(Ò)->
»suÉs
[(i)].
key2
)

	)

132 
	#RESULT_VALUE2
(
n
, 
i
è(Ò)->
»suÉs
[(i)].
v®ue2
)

	)

133 
	s_OuutPage
 {

135 
ResuÉ
 
	m»suÉs
[
OUTPUT_ORDER
];

136 
	m¥aû
[
PAGE_SIZE
];

140 
off_t
 
	mfe_off£t
;

141 } 
	tOuutPage
;

144 
İ’_bË
(cÚ¡ * 
f’ame
);

148 
şo£_db
(
bË_id
);

151 
off_t
 
g‘_ä“_·ge
(
bË_id
);

154 
put_ä“_·ge
(
bË_id
, 
off_t
 
·ge_off£t
);

157 
ex·nd_fe
(
bË_id
, 
size_t
 
út_·ge_to_ex·nd
);

160 
lßd_·ge
(
bË_id
, 
off_t
 
off£t
, 
Page
* 
·ge
);

163 
æush_·ge
(
bË_id
, 
Page
* 
·ge
);

165 
H—d”Page
 
dbh—d”
[10];

169 
	s_Bufãr
{

170 
Page
 *
	mäame
;

171 
	mbË_id
;

172 
off_t
 
	m·ge_off£t
;

173 
	mis_dœty
;

175 
	m»fb™
;

176 } 
	tBufãr
;

179 
lßd_·ge_äom_bufãr
(
bË_id
, 
off_t
 
off£t
, 
Page
* 
·ge
);

182 
Page
* 
check_bufãr_fÜ_lßd
(
bË_id
, 
off_t
 
off£t
);

185 
check_bufãr_fÜ_æush
(
bË_id
, 
off_t
 
off£t
);

187 
»¶aû_·ge
(
FILE
 *
fe
);

190 
æush_·ge_to_bufãr
(
bË_id
, 
Page
* 
·ge
);

193 
još_bË
(
bË_id_1
, 
bË_id_2
, *
·thÇme
);

195 
bË_šfo
(
bË_id
, 
ušt64_t
 *
num_keys
, ušt64_ˆ*
mš_key
, ušt64_ˆ*
max_key
);

197 
wr™e_ouut_bufãr
(
FILE
 *
fe
, 
ušt64_t
 
key1
, *
v®ue1
, ušt64_ˆ
key2
, *
v®ue2
);

199 
lßd_ouut_·ge
(
Page
 *
·ge
);

201 
æush_ouut_·ge
(
FILE
 *
fe
, 
Page
 *
·ge
);

203 
sync_bufãr
(
FILE
 *
fe
);

206 
	s_LogRecÜd
{

208 
off_t
 
	ml¢
;

209 
off_t
 
	m´ev_l¢
;

210 
	mxid
;

211 
	mty³
;

217 
	mbË_id
;

218 
	m²um
;

219 
	moff£t
;

220 
	mËngth
;

221 
	mŞd_image
[120];

222 
	mÃw_image
[120];

224 }
	tLogRecÜd
;

228 
begš_Œª§ùiÚ
();

233 
comm™_Œª§ùiÚ
();

237 
abÜ_Œª§ùiÚ
();

241 
upd©e
(
bË_id
, 
št64_t
 
key
, *
v®ue
);

243 
ü—‹_log
(
ty³
, 
bË_id
, 
²um
, 
off£t
, 
Ëngth
, *
Şd_image
, *
Ãw_image
);

245 
æush_log
(
size
);

247 
»cov”y
();

249 
execu‹_w®
();

	@src/bpt.c

4 
	#V”siÚ
 "1.14"

	)

57 
	~<¡dio.h
>

58 
	~<¡dlib.h
>

59 
	~<¡dboŞ.h
>

60 
	~<¡dšt.h
>

61 
	~<¡ršg.h
>

62 
	~<š‰y³s.h
>

63 
	~<as£¹.h
>

64 
	~<fú.h
>

65 
	~<uni¡d.h
>

66 
	~"b±.h
"

67 
	~"fe.h
"

68 #ifdeà
WINDOWS


69 
	#boŞ
 

	)

70 
	#çl£
 0

	)

71 
	#Œue
 1

	)

78 
	#MIN_ORDER
 3

	)

79 
	#MAX_ORDER
 256

	)

81 
	#SIZE_LOG_BUFFER
 3

	)

84 
	#LICENSE_FILE
 "LICENSE.txt"

	)

85 
	#LICENSE_WARRANTEE
 0

	)

86 
	#LICENSE_WARRANTEE_START
 592

	)

87 
	#LICENSE_WARRANTEE_END
 624

	)

88 
	#LICENSE_CONDITIONS
 1

	)

89 
	#LICENSE_CONDITIONS_START
 70

	)

90 
	#LICENSE_CONDITIONS_END
 625

	)

93 
H—d”Page
 
dbh—d”
[10];

94 
dbfe
[10];

95 
	gbË_ids
[10] = {0,};

107 
	gÜd”_š‹º®
 = 
BPTREE_INTERNAL_ORDER
;

108 
	gÜd”_Ëaf
 = 
BPTREE_LEAF_ORDER
;

115 
boŞ
 
	gv”bo£_ouut
 = 
çl£
;

118 
Bufãr
 *
	gbuf_mgr
;

119 
	gbuf_size
 = -1;

120 
	gşock_hªd
 = 0;

121 
	grg‘_buf
 = 0;

125 
LogRecÜd
 
	glog_buf
[
SIZE_LOG_BUFFER
];

128 
ušt64_t
 
	gxid
 = 0;

129 
ušt64_t
 
	gl¢
 = 
SIZE_LOG
;

130 
	glog
 = -1;

131 
	glog_hªd
 = 0;

137 
liûn£_nÙiû
( );

138 
´št_liûn£
Ğ
liûnû_·¹
 );

139 
u§ge_1
( );

140 
u§ge_2
( );

141 
fšd_ªd_´št
(
bË_id
, 
ušt64_t
 
key
);

142 
boŞ
 
fšd_Ëaf
(
bË_id
, 
ušt64_t
 
key
, 
L—fPage
* 
out_Ëaf_node
);

145 
¡¬t_Ãw_Œ“
(
bË_id
, 
ušt64_t
 
key
, cÚ¡ * 
v®ue
);

146 
š£¹_što_Ëaf
(
lbe_id
, 
L—fPage
* 
Ëaf_node
, 
ušt64_t
 
key
, cÚ¡ * 
v®ue
);

147 
š£¹_što_Ëaf_aá”_¥l™tšg
(
bË_id
, 
L—fPage
* 
Ëaf_node
, 
ušt64_t
 
key
, cÚ¡ * 
v®ue
);

148 
š£¹_što_·»Á
(
bË_id
, 
NodePage
* 
Ëá
, 
ušt64_t
 
key
, NodePage* 
right
);

149 
š£¹_što_Ãw_roÙ
(
bË_id
, 
NodePage
* 
Ëá
, 
ušt64_t
 
key
, NodePage* 
right
);

150 
g‘_Ëá_šdex
(
IÁ”ÇlPage
* 
·»Á
, 
off_t
 
Ëá_off£t
);

151 
š£¹_što_node
(
IÁ”ÇlPage
 * 
·»Á
, 
Ëá_šdex
, 
ušt64_t
 
key
, 
off_t
 
right_off£t
);

152 
š£¹_što_node_aá”_¥l™tšg
(
bË_id
, 
IÁ”ÇlPage
* 
·»Á
, 
Ëá_šdex
, 
ušt64_t
 
key
, 
off_t
 
right_off£t
);

155 
g‘_ÃighbÜ_šdex
(
bË_id
, 
NodePage
* 
node_·ge
);

156 
adju¡_roÙ
(
bË_id
);

157 
cßËsû_nodes
(
bË_id
, 
NodePage
* 
node_·ge
, NodePage* 
ÃighbÜ_·ge
,

158 
ÃighbÜ_šdex
, 
k_´ime
);

159 
»di¡ribu‹_nodes
(
bË_id
, 
NodePage
* 
node_·ge
, NodePage* 
ÃighbÜ_·ge
,

160 
ÃighbÜ_šdex
,

161 
k_´ime_šdex
, 
k_´ime
);

162 
d–‘e_’Œy
(
bË_id
, 
NodePage
* 
node_·ge
, 
ušt64_t
 
key
);

171 
	$liûn£_nÙiû
( ) {

172 
	`´štf
("bpt version %s -- Copyright (C) 2010 Amittai Aviram "

173 "h‰p://www.am™i.com\n", 
V”siÚ
);

174 
	`´štf
("This…rogram comes with ABSOLUTELY NO WARRANTY; for details "

178 
	}
}

183 
	$´št_liûn£
Ğ
liûn£_·¹
 ) {

184 
¡¬t
, 
’d
, 
lše
;

185 
FILE
 * 
å
;

186 
bufãr
[0x100];

188 
liûn£_·¹
) {

189 
LICENSE_WARRANTEE
:

190 
¡¬t
 = 
LICENSE_WARRANTEE_START
;

191 
’d
 = 
LICENSE_WARRANTEE_END
;

193 
LICENSE_CONDITIONS
:

194 
¡¬t
 = 
LICENSE_CONDITIONS_START
;

195 
’d
 = 
LICENSE_CONDITIONS_END
;

201 
å
 = 
	`fİ’
(
LICENSE_FILE
, "r");

202 ià(
å
 =ğ
NULL
) {

203 
	`³¼Ü
("print_license: fopen");

204 
	`ex™
(
EXIT_FAILURE
);

206 
lše
 = 0;†š< 
¡¬t
;†ine++)

207 
	`fg‘s
(
bufãr
, (bufãr), 
å
);

208  ; 
lše
 < 
’d
;†ine++) {

209 
	`fg‘s
(
bufãr
, (bufãr), 
å
);

210 
	`´štf
("%s", 
bufãr
);

212 
	`fşo£
(
å
);

213 
	}
}

217 
	$u§ge_1
( ) {

218 
	`´štf
("B+ T»oàOrd” %d(IÁ”Çl).\n", 
Üd”_š‹º®
);

219 
	`´štf
("Following Silberschatz, Korth, Sidarshan, Database Concepts, "

224 
	`´štf
("(%d <ğÜd” <ğ%d).\n", 
MIN_ORDER
, 
MAX_ORDER
);

225 
	`´štf
("To start with input from‡ file of‚ewline-delimited integers, \n"

228 
	}
}

232 
	$u§ge_2
( ) {

233 
	`´štf
("Enter‡ny ofhe following commands‡fterhe…rompt > :\n"

249 
	}
}

253 
	$İ’_bË
(cÚ¡ * 
f’ame
) {

254 
i
, 
bË_id
;

255 
size_t
 
Ën
;

257 
Ën
 = 
	`¡¾’
(
f’ame
);

259 if(()
Ën
 == 5){

260 
bË_id
 = 
f’ame
[4];

261 
i
 = 
bË_id
 - '0' - 1;

263 if(()
Ën
 == 6){

264 
i
 = 9;

268 
	`´štf
("Wrong input!\n");

272 
dbfe
[
i
] = 
	`İ’
(
f’ame
, 
O_RDWR
);

273 ià(
dbfe
[
i
] < 0) {

275 
dbfe
[
i
] = 
	`İ’
(
f’ame
, 
O_CREAT
|
O_RDWR
, 
S_IRUSR
|
S_IWUSR
);

276 ià(
dbfe
[
i
] < 0) {

277 
	`as£¹
("failedo create‚ew db file");

281 
	`mem£t
((
dbh—d”
+
i
), 0, 
PAGE_SIZE
);

282 
dbh—d”
[
i
].
ä“li¡
 = 0;

283 
dbh—d”
[
i
].
roÙ_off£t
 = 0;

284 
dbh—d”
[
i
].
num_·ges
 = 1;

285 
dbh—d”
[
i
].
fe_off£t
 = 0;

286 
dbh—d”
[
i
].
·ge_l¢
 = -1;

287 
	`æush_·ge_to_bufãr
(
i
+1, (
Page
*)(
dbh—d”
 + i));

290 
	`lßd_·ge_äom_bufãr
(
i
+1, 0, (
Page
*)(
dbh—d”
+i));

293 if(
dbh—d”
[
i
].
num_·ges
 == 0){

294 
dbh—d”
[
i
].
num_·ges
 = 1;

295 
	`æush_·ge_to_bufãr
(
i
+1, (
Page
*)(
dbh—d”
 + i));

297 
dbh—d”
[
i
].
fe_off£t
 = 0;

300  
i
+1;

301 
	}
}

304 
	$şo£_db
(
bË_id
) {

305 
	`şo£
(
dbfe
[
bË_id
 - 1]);

306 
	}
}

321 
off_t
 
	gqueue
[
BPTREE_MAX_NODE
];

322 
	$´št_Œ“
(
bË_id
) {

324 
i
;

325 
äÚt
 = 0;

326 
»¬
 = 0;

328 ià(
dbh—d”
[
bË_id
 - 1].
roÙ_off£t
 == 0) {

329 
	`´štf
("Emptyree.\n");

333 
queue
[
»¬
] = 
dbh—d”
[
bË_id
 - 1].
roÙ_off£t
;

334 
»¬
++;

335 
queue
[
»¬
] = 0;

336 
»¬
++;

337 
äÚt
 < 
»¬
) {

338 
off_t
 
·ge_off£t
 = 
queue
[
äÚt
];

339 
äÚt
++;

341 ià(
·ge_off£t
 == 0) {

342 
	`´štf
("\n");

344 ià(
äÚt
 =ğ
»¬
) ;

347 
queue
[
»¬
] = 0;

348 
»¬
++;

352 
NodePage
 
node_·ge
;

353 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
·ge_off£t
, (
Page
*)&
node_·ge
);

354 ià(
node_·ge
.
is_Ëaf
 == 1) {

356 
L—fPage
* 
Ëaf_node
 = (L—fPage*)&
node_·ge
;

357 
i
 = 0; i < 
Ëaf_node
->
num_keys
; i++) {

358 
	`´štf
("%" 
PRIu64
 " ", 
	`LEAF_KEY
(
Ëaf_node
, 
i
));

360 
	`´štf
("| ");

363 
IÁ”ÇlPage
* 
š‹º®_node
 = (IÁ”ÇlPage*)&
node_·ge
;

364 
i
 = 0; i < 
š‹º®_node
->
num_keys
; i++) {

365 
	`´štf
("%" 
PRIu64
 " ", 
	`INTERNAL_KEY
(
š‹º®_node
, 
i
));

366 
queue
[
»¬
] = 
	`INTERNAL_OFFSET
(
š‹º®_node
, 
i
);

367 
»¬
++;

369 
queue
[
»¬
] = 
	`INTERNAL_OFFSET
(
š‹º®_node
, 
i
);

370 
»¬
++;

371 
	`´štf
("| ");

374 
	}
}

379 
	$fšd_ªd_´št
(
bË_id
, 
ušt64_t
 
key
) {

380 * 
v®ue_found
 = 
NULL
;

381 
v®ue_found
 = 
	`fšd
(
bË_id
, 
key
);

382 ià(
v®ue_found
 =ğ
NULL
) {

383 
	`´štf
("RecÜd‚Ù found und” key %" 
PRIu64
 ".\n", 
key
);

386 
	`´štf
("key %" 
PRIu64
 ", v®u[%s].\n", 
key
, 
v®ue_found
);

387 
	`ä“
(
v®ue_found
);

389 
	}
}

396 
boŞ
 
	$fšd_Ëaf
(
bË_id
, 
ušt64_t
 
key
, 
L—fPage
* 
out_Ëaf_node
) {

397 
i
 = 0;

398 
off_t
 
roÙ_off£t
 = 
dbh—d”
[
bË_id
 - 1].root_offset;

400 ià(
roÙ_off£t
 == 0) {

401  
çl£
;

404 
NodePage
 
·ge
;

405 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
roÙ_off£t
, (
Page
*)&
·ge
);

407 !
·ge
.
is_Ëaf
) {

408 
IÁ”ÇlPage
* 
š‹º®_node
 = (IÁ”ÇlPage*)&
·ge
;

410 
i
 = 0;

411 
i
 < 
š‹º®_node
->
num_keys
) {

412 ià(
key
 >ğ
	`INTERNAL_KEY
(
š‹º®_node
, 
i
)) i++;

416 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
	`INTERNAL_OFFSET
(
š‹º®_node
, 
i
), (
Page
*)&
·ge
);

419 
	`memıy
(
out_Ëaf_node
, &
·ge
, (
L—fPage
));

421  
Œue
;

422 
	}
}

428 * 
	$fšd
(
bË_id
, 
ušt64_t
 
key
) {

429 
i
 = 0;

430 * 
out_v®ue
;

432 
L—fPage
 
Ëaf_node
;

433 ià(!
	`fšd_Ëaf
(
bË_id
, 
key
, &
Ëaf_node
)) {

434  
NULL
;

437 
i
 = 0; i < 
Ëaf_node
.
num_keys
; i++) {

438 ià(
	`LEAF_KEY
(&
Ëaf_node
, 
i
è=ğ
key
) {

439 
out_v®ue
 = (*)
	`m®loc
(
SIZE_VALUE
 * ());

440 
	`memıy
(
out_v®ue
, 
	`LEAF_VALUE
(&
Ëaf_node
, 
i
), 
SIZE_VALUE
);

441  
out_v®ue
;

445  
NULL
;

446 
	}
}

451 
	$cut
Ğ
Ëngth
 ) {

452 ià(
Ëngth
 % 2 == 0)

453  
Ëngth
/2;

455  
Ëngth
/2 + 1;

456 
	}
}

463 
	$g‘_Ëá_šdex
(
IÁ”ÇlPage
* 
·»Á
, 
off_t
 
Ëá_off£t
) {

465 
Ëá_šdex
 = 0;

466 
Ëá_šdex
 <ğ
·»Á
->
num_keys
 &&

467 
	`INTERNAL_OFFSET
(
·»Á
, 
Ëá_šdex
è!ğ
Ëá_off£t
)

468 
Ëá_šdex
++;

469  
Ëá_šdex
;

470 
	}
}

476 
	$š£¹_što_Ëaf
(
bË_id
, 
L—fPage
* 
Ëaf_node
, 
ušt64_t
 
key
, cÚ¡ * 
v®ue
) {

477 
š£¹iÚ_pošt
;

478 
i
;

480 
š£¹iÚ_pošt
 = 0;

481 
š£¹iÚ_pošt
 < 
Ëaf_node
->
num_keys
 &&

482 
	`LEAF_KEY
(
Ëaf_node
, 
š£¹iÚ_pošt
è< 
key
)

483 
š£¹iÚ_pošt
++;

486 
i
 = 
Ëaf_node
->
num_keys
 - 1; i >ğ
š£¹iÚ_pošt
; i--) {

487 
	`LEAF_KEY
(
Ëaf_node
, 
i
+1) = LEAF_KEY(leaf_node, i);

488 
	`memıy
(
	`LEAF_VALUE
(
Ëaf_node
, 
i
+1), LEAF_VALUEÖ—f_node, i), 
SIZE_VALUE
);

491 
	`LEAF_KEY
(
Ëaf_node
, 
š£¹iÚ_pošt
èğ
key
;

492 
	`memıy
(
	`LEAF_VALUE
(
Ëaf_node
, 
š£¹iÚ_pošt
), 
v®ue
, 
SIZE_VALUE
);

493 
Ëaf_node
->
num_keys
++;

496 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
Ëaf_node
);

497 
	}
}

504 
	$š£¹_što_Ëaf_aá”_¥l™tšg
(
bË_id
, 
L—fPage
* 
Ëaf
, 
ušt64_t
 
key
, cÚ¡ * 
v®ue
) {

506 
š£¹iÚ_šdex
, 
¥l™
, 
i
, 
j
;

507 
ušt64_t
 
Ãw_key
;

510 
L—fPage
 
Ãw_Ëaf
;

511 
Ãw_Ëaf
.
is_Ëaf
 = 
Œue
;

512 
Ãw_Ëaf
.
num_keys
 = 0;

514 
š£¹iÚ_šdex
 = 0;

515 
š£¹iÚ_šdex
 < 
Üd”_Ëaf
 - 1 && 
	`LEAF_KEY
(
Ëaf
, in£¹iÚ_šdexè< 
key
)

516 
š£¹iÚ_šdex
++;

518 
¥l™
 = 
	`cut
(
Üd”_Ëaf
 - 1);

520 ià(
š£¹iÚ_šdex
 < 
¥l™
) {

522 
i
 = 
¥l™
 - 1, 
j
 = 0; i < 
Üd”_Ëaf
 - 1; i++, j++) {

523 
	`LEAF_KEY
(&
Ãw_Ëaf
, 
j
èğLEAF_KEY(
Ëaf
, 
i
);

524 
	`memıy
(
	`LEAF_VALUE
(&
Ãw_Ëaf
, 
j
), LEAF_VALUE(
Ëaf
, 
i
), 
SIZE_VALUE
);

526 
Ãw_Ëaf
.
num_keys
++;

527 
Ëaf
->
num_keys
--;

530 
i
 = 
¥l™
 - 2; i >ğ
š£¹iÚ_šdex
; i--) {

531 
	`LEAF_KEY
(
Ëaf
, 
i
+1) = LEAF_KEY(leaf, i);

532 
	`memıy
(
	`LEAF_VALUE
(
Ëaf
, 
i
+1), LEAF_VALUEÖ—f, i), 
SIZE_VALUE
);

534 
	`LEAF_KEY
(
Ëaf
, 
š£¹iÚ_šdex
èğ
key
;

535 
	`memıy
(
	`LEAF_VALUE
(
Ëaf
, 
š£¹iÚ_šdex
), 
v®ue
, 
SIZE_VALUE
);

536 
Ëaf
->
num_keys
++;

539 
i
 = 
¥l™
, 
j
 = 0; i < 
Üd”_Ëaf
 - 1; i++, j++) {

540 ià(
i
 =ğ
š£¹iÚ_šdex
) {

542 
j
++;

544 
	`LEAF_KEY
(&
Ãw_Ëaf
, 
j
èğLEAF_KEY(
Ëaf
, 
i
);

545 
	`memıy
(
	`LEAF_VALUE
(&
Ãw_Ëaf
, 
j
), LEAF_VALUE(
Ëaf
, 
i
), 
SIZE_VALUE
);

547 
Ãw_Ëaf
.
num_keys
++;

548 
Ëaf
->
num_keys
--;

550 
	`LEAF_KEY
(&
Ãw_Ëaf
, 
š£¹iÚ_šdex
 - 
¥l™
èğ
key
;

551 
	`memıy
(
	`LEAF_VALUE
(&
Ãw_Ëaf
, 
š£¹iÚ_šdex
 - 
¥l™
), 
v®ue
, 
SIZE_VALUE
);

552 
Ãw_Ëaf
.
num_keys
++;

556 
Ãw_Ëaf
.
fe_off£t
 = 
	`g‘_ä“_·ge
(
bË_id
);

559 
Ãw_Ëaf
.
·ge_l¢
 = -1;

562 
Ãw_Ëaf
.
siblšg
 = 
Ëaf
->sibling;

563 
Ëaf
->
siblšg
 = 
Ãw_Ëaf
.
fe_off£t
;

566 
i
 = 
Ëaf
->
num_keys
; i < 
Üd”_Ëaf
 - 1; i++) {

567 
	`LEAF_KEY
(
Ëaf
, 
i
) = 0;

568 
	`mem£t
(
	`LEAF_VALUE
(
Ëaf
, 
i
), 0, 
SIZE_VALUE
);

570 
i
 = 
Ãw_Ëaf
.
num_keys
; i < 
Üd”_Ëaf
 - 1; i++) {

571 
	`LEAF_KEY
(&
Ãw_Ëaf
, 
i
) = 0;

572 
	`mem£t
(
	`LEAF_VALUE
(&
Ãw_Ëaf
, 
i
), 0, 
SIZE_VALUE
);

575 
Ãw_Ëaf
.
·»Á
 = 
Ëaf
->parent;

577 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
Ëaf
);

578 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
Ãw_Ëaf
);

580 
Ãw_key
 = 
	`LEAF_KEY
(&
Ãw_Ëaf
, 0);

583 
	`š£¹_što_·»Á
(
bË_id
, (
NodePage
*)
Ëaf
, 
Ãw_key
, (NodePage*)&
Ãw_Ëaf
);

584 
	}
}

590 
	$š£¹_što_node
(
IÁ”ÇlPage
* 
n
, 
Ëá_šdex
, 
ušt64_t
 
key
, 
off_t
 
right_off£t
) {

591 
i
;

593 
i
 = 
n
->
num_keys
; i > 
Ëá_šdex
; i--) {

594 
	`INTERNAL_OFFSET
(
n
, 
i
 + 1) = INTERNAL_OFFSET(n, i);

595 
	`INTERNAL_KEY
(
n
, 
i
) = INTERNAL_KEY(n, i - 1);

597 
	`INTERNAL_OFFSET
(
n
, 
Ëá_šdex
 + 1èğ
right_off£t
;

598 
	`INTERNAL_KEY
(
n
, 
Ëá_šdex
èğ
key
;

599 
n
->
num_keys
++;

600 
	}
}

606 
	$š£¹_što_node_aá”_¥l™tšg
(
bË_id
, 
IÁ”ÇlPage
* 
Şd_node
, 
Ëá_šdex
, 
ušt64_t
 
key
, 
off_t
 
right_off£t
) {

607 
i
, 
j
, 
¥l™
, 
k_´ime
;

608 
ušt64_t
* 
‹mp_keys
;

609 
off_t
* 
‹mp_poš‹rs
;

620 
‹mp_poš‹rs
 = 
	`m®loc
Ğ(
Üd”_š‹º®
 + 1è* (
off_t
) );

621 ià(
‹mp_poš‹rs
 =ğ
NULL
) {

622 
	`³¼Ü
("Temporary…ointers‡rray for splitting‚odes.");

623 
	`ex™
(
EXIT_FAILURE
);

625 
‹mp_keys
 = 
	`m®loc
Ğ
Üd”_š‹º®
 * (
ušt64_t
) );

626 ià(
‹mp_keys
 =ğ
NULL
) {

627 
	`³¼Ü
("Temporary keys‡rray for splitting‚odes.");

628 
	`ex™
(
EXIT_FAILURE
);

631 
i
 = 0, 
j
 = 0; i < 
Şd_node
->
num_keys
 + 1; i++, j++) {

632 ià(
j
 =ğ
Ëá_šdex
 + 1) j++;

633 
‹mp_poš‹rs
[
j
] = 
	`INTERNAL_OFFSET
(
Şd_node
, 
i
);

636 
i
 = 0, 
j
 = 0; i < 
Şd_node
->
num_keys
; i++, j++) {

637 ià(
j
 =ğ
Ëá_šdex
) j++;

638 
‹mp_keys
[
j
] = 
	`INTERNAL_KEY
(
Şd_node
, 
i
);

641 
‹mp_poš‹rs
[
Ëá_šdex
 + 1] = 
right_off£t
;

642 
‹mp_keys
[
Ëá_šdex
] = 
key
;

648 
¥l™
 = 
	`cut
(
Üd”_š‹º®
);

650 
IÁ”ÇlPage
 
Ãw_node
;

651 
Ãw_node
.
num_keys
 = 0;

652 
Ãw_node
.
is_Ëaf
 = 0;

653 
Ãw_node
.
fe_off£t
 = 
	`g‘_ä“_·ge
(
bË_id
);

656 
Ãw_node
.
·ge_l¢
 = -1;

658 
Şd_node
->
num_keys
 = 0;

659 
i
 = 0; i < 
¥l™
 - 1; i++) {

660 
	`INTERNAL_OFFSET
(
Şd_node
, 
i
èğ
‹mp_poš‹rs
[i];

661 
	`INTERNAL_KEY
(
Şd_node
, 
i
èğ
‹mp_keys
[i];

662 
Şd_node
->
num_keys
++;

664 
	`INTERNAL_OFFSET
(
Şd_node
, 
i
èğ
‹mp_poš‹rs
[i];

665 
k_´ime
 = 
‹mp_keys
[
¥l™
 - 1];

666 ++
i
, 
j
 = 0; i < 
Üd”_š‹º®
; i++, j++) {

667 
	`INTERNAL_OFFSET
(&
Ãw_node
, 
j
èğ
‹mp_poš‹rs
[
i
];

668 
	`INTERNAL_KEY
(&
Ãw_node
, 
j
èğ
‹mp_keys
[
i
];

669 
Ãw_node
.
num_keys
++;

671 
	`INTERNAL_OFFSET
(&
Ãw_node
, 
j
èğ
‹mp_poš‹rs
[
i
];

672 
	`ä“
(
‹mp_poš‹rs
);

673 
	`ä“
(
‹mp_keys
);

674 
Ãw_node
.
·»Á
 = 
Şd_node
->parent;

675 
i
 = 0; i <ğ
Ãw_node
.
num_keys
; i++) {

676 
NodePage
 
chd_·ge
;

677 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
	`INTERNAL_OFFSET
(&
Ãw_node
, 
i
), (
Page
*)&
chd_·ge
);

678 
chd_·ge
.
·»Á
 = 
Ãw_node
.
fe_off£t
;

679 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
chd_·ge
);

683 
i
 = 
Şd_node
->
num_keys
; i < 
Üd”_š‹º®
 - 1; i++) {

684 
	`INTERNAL_OFFSET
(
Şd_node
, 
i
+1) = 0;

685 
	`INTERNAL_KEY
(
Şd_node
, 
i
) = 0;

688 
i
 = 
Ãw_node
.
num_keys
; i < 
Üd”_š‹º®
 - 1; i++) {

689 
	`INTERNAL_OFFSET
(&
Ãw_node
, 
i
+1) = 0;

690 
	`INTERNAL_KEY
(&
Ãw_node
, 
i
) = 0;

694 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
Ãw_node
);

695 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
Şd_node
);

701 
	`š£¹_što_·»Á
(
bË_id
, (
NodePage
*)
Şd_node
, 
k_´ime
, (NodePage*)&
Ãw_node
);

702 
	}
}

707 
	$š£¹_što_·»Á
(
bË_id
, 
NodePage
* 
Ëá
, 
ušt64_t
 
key
, NodePage* 
right
) {

709 
IÁ”ÇlPage
 
·»Á_node
;

712 ià(
Ëá
->
·»Á
 == 0) {

713 
	`š£¹_što_Ãw_roÙ
(
bË_id
, 
Ëá
, 
key
, 
right
);

717 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
Ëá
->
·»Á
, (
Page
*)&
·»Á_node
);

727 
Ëá_šdex
 = 
	`g‘_Ëá_šdex
(&
·»Á_node
, 
Ëá
->
fe_off£t
);

732 ià(
·»Á_node
.
num_keys
 < 
Üd”_š‹º®
 - 1) {

733 
	`š£¹_što_node
(&
·»Á_node
, 
Ëá_šdex
, 
key
, 
right
->
fe_off£t
);

734 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
·»Á_node
);

742  
	`š£¹_što_node_aá”_¥l™tšg
(
bË_id
, &
·»Á_node
, 
Ëá_šdex
, 
key
, 
right
->
fe_off£t
);

743 
	}
}

749 
	$š£¹_što_Ãw_roÙ
(
bË_id
, 
NodePage
* 
Ëá
, 
ušt64_t
 
key
, NodePage* 
right
) {

751 
IÁ”ÇlPage
 
roÙ_node
;

752 
	`mem£t
(&
roÙ_node
, 0, (
IÁ”ÇlPage
));

753 
roÙ_node
.
fe_off£t
 = 
	`g‘_ä“_·ge
(
bË_id
);

756 
roÙ_node
.
·ge_l¢
 = -1;

758 
	`INTERNAL_KEY
(&
roÙ_node
, 0èğ
key
;

759 
	`INTERNAL_OFFSET
(&
roÙ_node
, 0èğ
Ëá
->
fe_off£t
;

760 
	`INTERNAL_OFFSET
(&
roÙ_node
, 1èğ
right
->
fe_off£t
;

761 
roÙ_node
.
num_keys
++;

762 
roÙ_node
.
·»Á
 = 0;

763 
roÙ_node
.
is_Ëaf
 = 0;

764 
Ëá
->
·»Á
 = 
roÙ_node
.
fe_off£t
;

765 
right
->
·»Á
 = 
roÙ_node
.
fe_off£t
;

767 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
roÙ_node
);

768 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
Ëá
);

769 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
right
);

771 
dbh—d”
[
bË_id
 - 1].
roÙ_off£t
 = 
roÙ_node
.
fe_off£t
;

772 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)(
dbh—d”
 +able_id - 1));

773 
	}
}

777 
	$¡¬t_Ãw_Œ“
(
bË_id
, 
ušt64_t
 
key
, cÚ¡ * 
v®ue
) {

778 
L—fPage
 
roÙ_node
;

780 
off_t
 
roÙ_off£t
 = 
	`g‘_ä“_·ge
(
bË_id
);

781 
roÙ_node
.
fe_off£t
 = 
roÙ_off£t
;

783 
roÙ_node
.
·»Á
 = 0;

784 
roÙ_node
.
is_Ëaf
 = 1;

785 
roÙ_node
.
num_keys
 = 1;

786 
	`LEAF_KEY
(&
roÙ_node
, 0èğ
key
;

787 
roÙ_node
.
siblšg
 = 0;

790 
roÙ_node
.
·ge_l¢
 = -1;

792 
	`memıy
(
	`LEAF_VALUE
(&
roÙ_node
, 0), 
v®ue
, 
SIZE_VALUE
);

794 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
roÙ_node
);

796 
dbh—d”
[
bË_id
 - 1].
roÙ_off£t
 =„oot_offset;

797 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)(
dbh—d”
 +able_id - 1));

798 
	}
}

806 
	$š£¹
(
bË_id
, 
ušt64_t
 
key
, cÚ¡ * 
v®ue
) {

810 * 
v®ue_found
 = 
NULL
;

812 ià((
v®ue_found
 = 
	`fšd
(
bË_id
, 
key
)) != 0) {

813 
	`ä“
(
v®ue_found
);

820 ià(
dbh—d”
[
bË_id
 - 1].
roÙ_off£t
 == 0) {

821 
	`¡¬t_Ãw_Œ“
(
bË_id
, 
key
, 
v®ue
);

829 
L—fPage
 
Ëaf_node
;

830 
	`fšd_Ëaf
(
bË_id
, 
key
, &
Ëaf_node
);

835 ià(
Ëaf_node
.
num_keys
 < 
Üd”_Ëaf
 - 1) {

836 
	`š£¹_što_Ëaf
(
bË_id
, &
Ëaf_node
, 
key
, 
v®ue
);

840 
	`š£¹_što_Ëaf_aá”_¥l™tšg
(
bË_id
, &
Ëaf_node
, 
key
, 
v®ue
);

843 
	}
}

853 
	$g‘_ÃighbÜ_šdex
(
bË_id
, 
NodePage
* 
node_·ge
) {

855 
i
;

863 
IÁ”ÇlPage
 
·»Á_node
;

864 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
node_·ge
->
·»Á
, (
Page
*)&
·»Á_node
);

865 
i
 = 0; i <ğ
·»Á_node
.
num_keys
; i++)

866 ià(
	`INTERNAL_OFFSET
(&
·»Á_node
, 
i
è=ğ
node_·ge
->
fe_off£t
)

867  
i
 - 1;

870 
	`as£¹
("Search for‚onexistent…ointero‚ode in…arent.");

872 
	}
}

874 
	$»move_’Œy_äom_node
(
bË_id
, 
NodePage
* 
node_·ge
, 
ušt64_t
 
key
) {

876 
i
;

877 
key_idx
 = 0;

879 ià(
node_·ge
->
is_Ëaf
) {

880 
L—fPage
* 
Ëaf_node
 = (L—fPage*)
node_·ge
;

883 
i
 = 0; i < 
Ëaf_node
->
num_keys
; i++) {

884 ià(
	`LEAF_KEY
(
Ëaf_node
, 
i
è=ğ
key
) {

885 
key_idx
 = 
i
;

889 ià(
i
 =ğ
Ëaf_node
->
num_keys
) {

890 
	`as£¹
("remove_entry_from_node:‚o key inhis…age");

894 
i
 = 
key_idx
; i < 
Ëaf_node
->
num_keys
 - 1; i++) {

895 
	`LEAF_KEY
(
Ëaf_node
, 
i
) = LEAF_KEY(leaf_node, i+1);

896 
	`memıy
(
	`LEAF_VALUE
(
Ëaf_node
, 
i
), LEAF_VALUEÖ—f_node, i+1), 
SIZE_VALUE
);

899 
	`LEAF_KEY
(
Ëaf_node
,†—f_node->
num_keys
 - 1) = 0;

900 
	`mem£t
(
	`LEAF_VALUE
(
Ëaf_node
,†—f_node->
num_keys
 - 1), 0, 
SIZE_VALUE
);

902 
Ëaf_node
->
num_keys
--;

905 
IÁ”ÇlPage
* 
š‹º®_node
 = (IÁ”ÇlPage*)
node_·ge
;

908 
i
 = 0; i < 
š‹º®_node
->
num_keys
; i++) {

909 ià(
	`INTERNAL_KEY
(
š‹º®_node
, 
i
è=ğ
key
) {

910 
key_idx
 = 
i
;

914 ià(
i
 =ğ
š‹º®_node
->
num_keys
) {

915 
	`as£¹
("remove_entry_from_node:‚o key inhis…age");

919 
i
 = 
key_idx
; i < 
š‹º®_node
->
num_keys
 - 1; i++) {

920 
	`INTERNAL_KEY
(
š‹º®_node
, 
i
) = INTERNAL_KEY(internal_node, i+1);

921 
	`INTERNAL_OFFSET
(
š‹º®_node
, 
i
+1) = INTERNAL_OFFSET(internal_node, i+2);

924 
	`INTERNAL_KEY
(
š‹º®_node
, iÁ”Çl_node->
num_keys
 - 1) = 0;

925 
	`INTERNAL_OFFSET
(
š‹º®_node
, iÁ”Çl_node->
num_keys
) = 0;

927 
š‹º®_node
->
num_keys
--;

930 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
node_·ge
);

931 
	}
}

933 
	$adju¡_roÙ
(
bË_id
) {

935 
NodePage
 
roÙ_·ge
;

936 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
dbh—d”
[bË_id - 1].
roÙ_off£t
, (
Page
*)&
roÙ_·ge
);

943 ià(
roÙ_·ge
.
num_keys
 > 0)

953 ià(!
roÙ_·ge
.
is_Ëaf
) {

954 
IÁ”ÇlPage
* 
roÙ_node
 = (IÁ”ÇlPage*)&
roÙ_·ge
;

955 
dbh—d”
[
bË_id
 - 1].
roÙ_off£t
 = 
	`INTERNAL_OFFSET
(
roÙ_node
, 0);

957 
NodePage
 
node_·ge
;

958 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
dbh—d”
[bË_id - 1].
roÙ_off£t
, (
Page
*)&
node_·ge
);

959 
node_·ge
.
·»Á
 = 0;

961 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
node_·ge
);

962 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)(
dbh—d”
 +able_id - 1));

969 
dbh—d”
[
bË_id
 - 1].
roÙ_off£t
 = 0;

970 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)(
dbh—d”
 +able_id - 1));

973 
	`put_ä“_·ge
(
bË_id
, 
roÙ_·ge
.
fe_off£t
);

974 
	}
}

982 
	$cßËsû_nodes
(
bË_id
, 
NodePage
* 
node_·ge
, NodePage* 
ÃighbÜ_·ge
, 
ÃighbÜ_šdex
, 
k_´ime
) {

984 
i
, 
j
, 
ÃighbÜ_š£¹iÚ_šdex
, 
n_’d
;

985 
NodePage
* 
tmp
;

991 ià(
ÃighbÜ_šdex
 == -1) {

992 
tmp
 = 
node_·ge
;

993 
node_·ge
 = 
ÃighbÜ_·ge
;

994 
ÃighbÜ_·ge
 = 
tmp
;

1003 
ÃighbÜ_š£¹iÚ_šdex
 = 
ÃighbÜ_·ge
->
num_keys
;

1010 ià(!
node_·ge
->
is_Ëaf
) {

1011 
IÁ”ÇlPage
* 
node
 = (IÁ”ÇlPage*)
node_·ge
;

1012 
IÁ”ÇlPage
* 
ÃighbÜ_node
 = (IÁ”ÇlPage*)
ÃighbÜ_·ge
;

1017 
	`INTERNAL_KEY
(
ÃighbÜ_node
, 
ÃighbÜ_š£¹iÚ_šdex
èğ
k_´ime
;

1018 
ÃighbÜ_node
->
num_keys
++;

1020 
n_’d
 = 
node
->
num_keys
;

1022 
i
 = 
ÃighbÜ_š£¹iÚ_šdex
 + 1, 
j
 = 0; j < 
n_’d
; i++, j++) {

1023 
	`INTERNAL_KEY
(
ÃighbÜ_node
, 
i
èğINTERNAL_KEY(
node
, 
j
);

1024 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
, 
i
èğINTERNAL_OFFSET(
node
, 
j
);

1025 
ÃighbÜ_node
->
num_keys
++;

1026 
node
->
num_keys
--;

1033 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
, 
i
èğINTERNAL_OFFSET(
node
, 
j
);

1038 
i
 = 0; i < 
ÃighbÜ_node
->
num_keys
 + 1; i++) {

1039 
NodePage
 
chd_·ge
;

1040 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
, 
i
), (
Page
*)&
chd_·ge
);

1041 
chd_·ge
.
·»Á
 = 
ÃighbÜ_node
->
fe_off£t
;

1042 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
chd_·ge
);

1045 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
ÃighbÜ_node
);

1047 
	`put_ä“_·ge
(
bË_id
, 
node
->
fe_off£t
);

1057 
L—fPage
* 
node
 = (L—fPage*)
node_·ge
;

1058 
L—fPage
* 
ÃighbÜ_node
 = (L—fPage*)
ÃighbÜ_·ge
;

1060 
i
 = 
ÃighbÜ_š£¹iÚ_šdex
, 
j
 = 0; j < 
node
->
num_keys
; i++, j++) {

1061 
	`LEAF_KEY
(
ÃighbÜ_node
, 
i
èğLEAF_KEY(
node
, 
j
);

1062 
	`memıy
(
	`LEAF_VALUE
(
ÃighbÜ_node
, 
i
), LEAF_VALUE(
node
, 
j
), 
SIZE_VALUE
);

1063 
ÃighbÜ_node
->
num_keys
++;

1065 
ÃighbÜ_node
->
siblšg
 = 
node
->sibling;

1067 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
ÃighbÜ_node
);

1069 
	`put_ä“_·ge
(
bË_id
, 
node
->
fe_off£t
);

1072 
NodePage
 
·»Á_node
;

1073 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
node_·ge
->
·»Á
, (
Page
*)&
·»Á_node
);

1074 
	`d–‘e_’Œy
(
bË_id
, &
·»Á_node
, 
k_´ime
);

1075 
	}
}

1083 
	$»di¡ribu‹_nodes
(
bË_id
, 
NodePage
* 
node_·ge
, NodePage* 
ÃighbÜ_·ge
,

1084 
ÃighbÜ_šdex
,

1085 
k_´ime_šdex
, 
k_´ime
) {

1087 
i
;

1094 ià(
ÃighbÜ_šdex
 != -1) {

1095 ià(!
node_·ge
->
is_Ëaf
) {

1096 
IÁ”ÇlPage
* 
node
 = (IÁ”ÇlPage*)
node_·ge
;

1097 
IÁ”ÇlPage
* 
ÃighbÜ_node
 = (IÁ”ÇlPage*)
ÃighbÜ_·ge
;

1098 
	`INTERNAL_OFFSET
(
node
,‚ode->
num_keys
 + 1) = INTERNAL_OFFSET(node,‚ode->num_keys);

1100 
i
 = 
node
->
num_keys
; i > 0; i--) {

1101 
	`INTERNAL_KEY
(
node
, 
i
) = INTERNAL_KEY(node, i - 1);

1102 
	`INTERNAL_OFFSET
(
node
, 
i
) = INTERNAL_OFFSET(node, i - 1);

1104 
	`INTERNAL_OFFSET
(
node
, 0èğINTERNAL_OFFSET(
ÃighbÜ_node
,‚eighbÜ_node->
num_keys
);

1105 
NodePage
 
chd_·ge
;

1106 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
	`INTERNAL_OFFSET
(
node
, 0), (
Page
*)&
chd_·ge
);

1107 
chd_·ge
.
·»Á
 = 
node
->
fe_off£t
;

1108 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
chd_·ge
);

1110 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
,‚eighbÜ_node->
num_keys
) = 0;

1111 
	`INTERNAL_KEY
(
node
, 0èğ
k_´ime
;

1113 
IÁ”ÇlPage
 
·»Á_node
;

1114 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
node
->
·»Á
, (
Page
*)&
·»Á_node
);

1115 
	`INTERNAL_KEY
(&
·»Á_node
, 
k_´ime_šdex
èğINTERNAL_KEY(
ÃighbÜ_node
,‚eighbÜ_node->
num_keys
 - 1);

1116 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
·»Á_node
);

1121 
node
->
num_keys
++;

1122 
ÃighbÜ_node
->
num_keys
--;

1124 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
node_·ge
);

1125 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
ÃighbÜ_·ge
);

1128 
L—fPage
* 
node
 = (L—fPage*)
node_·ge
;

1129 
L—fPage
* 
ÃighbÜ_node
 = (L—fPage*)
ÃighbÜ_·ge
;

1131 
i
 = 
node
->
num_keys
; i > 0; i--) {

1132 
	`LEAF_KEY
(
node
, 
i
) = LEAF_KEY(node, i - 1);

1133 
	`memıy
(
	`LEAF_VALUE
(
node
, 
i
), LEAF_VALUEÒode, i - 1), 
SIZE_VALUE
);

1135 
	`memıy
(
	`LEAF_VALUE
(
node
, 0), LEAF_VALUE(
ÃighbÜ_node
,‚eighbÜ_node->
num_keys
 - 1), 
SIZE_VALUE
);

1136 
	`mem£t
(
	`LEAF_VALUE
(
ÃighbÜ_node
,‚eighbÜ_node->
num_keys
 - 1), 0, 
SIZE_VALUE
);

1137 
	`LEAF_KEY
(
node
, 0èğLEAF_KEY(
ÃighbÜ_node
,‚eighbÜ_node->
num_keys
 - 1);

1139 
IÁ”ÇlPage
 
·»Á_node
;

1140 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
node
->
·»Á
, (
Page
*)&
·»Á_node
);

1141 
	`INTERNAL_KEY
(&
·»Á_node
, 
k_´ime_šdex
èğ
	`LEAF_KEY
(
node
, 0);

1142 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
·»Á_node
);

1147 
node
->
num_keys
++;

1148 
ÃighbÜ_node
->
num_keys
--;

1150 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
node_·ge
);

1151 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
ÃighbÜ_·ge
);

1162 ià(
node_·ge
->
is_Ëaf
) {

1163 
L—fPage
* 
node
 = (L—fPage*)
node_·ge
;

1164 
L—fPage
* 
ÃighbÜ_node
 = (L—fPage*)
ÃighbÜ_·ge
;;

1166 
	`LEAF_KEY
(
node
,‚ode->
num_keys
èğLEAF_KEY(
ÃighbÜ_node
, 0);

1167 
	`memıy
(
	`LEAF_VALUE
(
node
,‚ode->
num_keys
), LEAF_VALUE(
ÃighbÜ_node
, 0), 
SIZE_VALUE
);

1169 
IÁ”ÇlPage
 
·»Á_node
;

1170 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
node
->
·»Á
, (
Page
*)&
·»Á_node
);

1171 
	`INTERNAL_KEY
(&
·»Á_node
, 
k_´ime_šdex
èğ
	`LEAF_KEY
(
ÃighbÜ_node
, 1);

1172 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
·»Á_node
);

1174 
i
 = 0; i < 
ÃighbÜ_node
->
num_keys
 - 1; i++) {

1175 
	`LEAF_KEY
(
ÃighbÜ_node
, 
i
) = LEAF_KEY(neighbor_node, i + 1);

1176 
	`memıy
(
	`LEAF_VALUE
(
ÃighbÜ_node
, 
i
), LEAF_VALUEÒeighbÜ_node, i + 1), 
SIZE_VALUE
);

1182 
node
->
num_keys
++;

1183 
ÃighbÜ_node
->
num_keys
--;

1185 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
node_·ge
);

1186 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
ÃighbÜ_·ge
);

1190 
IÁ”ÇlPage
* 
node
 = (IÁ”ÇlPage*)
node_·ge
;

1191 
IÁ”ÇlPage
* 
ÃighbÜ_node
 = (IÁ”ÇlPage*)
ÃighbÜ_·ge
;

1193 
	`INTERNAL_KEY
(
node
,‚ode->
num_keys
èğ
k_´ime
;

1194 
	`INTERNAL_OFFSET
(
node
,‚ode->
num_keys
 + 1èğINTERNAL_OFFSET(
ÃighbÜ_node
, 0);

1196 
NodePage
 
chd_·ge
;

1197 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
	`INTERNAL_OFFSET
(
node
,‚ode->
num_keys
 + 1), (
Page
*)&
chd_·ge
);

1198 
chd_·ge
.
·»Á
 = 
node
->
fe_off£t
;

1199 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
chd_·ge
);

1201 
IÁ”ÇlPage
 
·»Á_node
;

1202 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
node
->
·»Á
, (
Page
*)&
·»Á_node
);

1203 
	`INTERNAL_KEY
(&
·»Á_node
, 
k_´ime_šdex
èğINTERNAL_KEY(
ÃighbÜ_node
, 0);

1204 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
·»Á_node
);

1206 
i
 = 0; i < 
ÃighbÜ_node
->
num_keys
 - 1; i++) {

1207 
	`INTERNAL_KEY
(
ÃighbÜ_node
, 
i
) = INTERNAL_KEY(neighbor_node, i + 1);

1208 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
, 
i
) = INTERNAL_OFFSET(neighbor_node, i + 1);

1211 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
, 
i
) = INTERNAL_OFFSET(neighbor_node, i + 1);

1218 
node
->
num_keys
++;

1219 
ÃighbÜ_node
->
num_keys
--;

1221 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
node_·ge
);

1222 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)
ÃighbÜ_·ge
);

1226 
	}
}

1234 
	$d–‘e_’Œy
(
bË_id
, 
NodePage
* 
node_·ge
, 
ušt64_t
 
key
) {

1236 
mš_keys
;

1237 
off_t
 
ÃighbÜ_off£t
;

1238 
ÃighbÜ_šdex
;

1239 
k_´ime_šdex
, 
k_´ime
;

1240 
ÿ·c™y
;

1244 
	`»move_’Œy_äom_node
(
bË_id
, 
node_·ge
, 
key
);

1248 ià(
dbh—d”
[
bË_id
 - 1].
roÙ_off£t
 =ğ
node_·ge
->
fe_off£t
) {

1249 
	`adju¡_roÙ
(
bË_id
);

1261 
mš_keys
 = 
node_·ge
->
is_Ëaf
 ? 
	`cut
(
Üd”_Ëaf
 - 1è: cut(
Üd”_š‹º®
) - 1;

1267 ià(
node_·ge
->
num_keys
 >ğ
mš_keys
)

1282 
ÃighbÜ_šdex
 = 
	`g‘_ÃighbÜ_šdex
(
bË_id
, 
node_·ge
);

1283 
k_´ime_šdex
 = 
ÃighbÜ_šdex
 == -1 ? 0 :‚eighbor_index;

1285 
IÁ”ÇlPage
 
·»Á_node
;

1286 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
node_·ge
->
·»Á
, (
Page
*)&
·»Á_node
);

1288 
k_´ime
 = 
	`INTERNAL_KEY
(&
·»Á_node
, 
k_´ime_šdex
);

1289 
ÃighbÜ_off£t
 = 
ÃighbÜ_šdex
 =ğ-1 ? 
	`INTERNAL_OFFSET
(&
·»Á_node
, 1) :

1290 
	`INTERNAL_OFFSET
(&
·»Á_node
, 
ÃighbÜ_šdex
);

1292 
ÿ·c™y
 = 
node_·ge
->
is_Ëaf
 ? 
Üd”_Ëaf
 : 
Üd”_š‹º®
 - 1;

1294 
NodePage
 
ÃighbÜ_·ge
;

1295 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
ÃighbÜ_off£t
, (
Page
*)&
ÃighbÜ_·ge
);

1298 ià(
ÃighbÜ_·ge
.
num_keys
 + 
node_·ge
->num_key < 
ÿ·c™y
)

1299 
	`cßËsû_nodes
(
bË_id
, 
node_·ge
, &
ÃighbÜ_·ge
, 
ÃighbÜ_šdex
, 
k_´ime
);

1304 
	`»di¡ribu‹_nodes
(
bË_id
, 
node_·ge
, &
ÃighbÜ_·ge
, 
ÃighbÜ_šdex
, 
k_´ime_šdex
, 
k_´ime
);

1307 
	}
}

1311 
	$d–‘e
(
bË_id
, 
ušt64_t
 
key
) {

1313 * 
v®ue_found
 = 
NULL
;

1314 ià((
v®ue_found
 = 
	`fšd
(
bË_id
, 
key
)) == 0) {

1316 
	`ä“
(
v®ue_found
);

1320 
L—fPage
 
Ëaf_node
;

1321 
	`fšd_Ëaf
(
bË_id
, 
key
, &
Ëaf_node
);

1323 
	`d–‘e_’Œy
(
bË_id
, (
NodePage
*)&
Ëaf_node
, 
key
);

1326 
	}
}

1329 
	$š™_db
(
num_buf
){

1330 
i
;

1333 
buf_mgr
 = (
Bufãr
 *)
	`ÿÎoc
(
num_buf
, (Buffer));

1335 
i
 = 0; i < 
num_buf
; i++){

1336 
buf_mgr
[
i
].
äame
 = (
Page
*)
	`m®loc
((Page));

1339 if(
buf_mgr
 =ğ
NULL
){

1346 
buf_size
 = 
num_buf
;

1349 
log
 = 
	`İ’
("log.db", 
O_RDWR
);

1354 if(
log
 > 0){

1356 
	`»cov”y
();

1359 
	`şo£
(
log
);

1360 
	`»move
("log.db");

1361 
log
 = -1;

1365 
	}
}

1367 
	$şo£_bË
(
bË_id
){

1368 
i
;

1371 if(
bË_id
 < 1 ||abË_id > 10 || 
buf_size
 =ğ-1 || 
buf_mgr
 =ğ
NULL
){

1375 
i
 = 0; i < 
buf_size
; i++){

1376 if(
buf_mgr
[
i
].
bË_id
 ==able_id){

1378 if(
buf_mgr
[
i
].
is_dœty
 == 1){

1379 
	`æush_·ge
(
bË_id
, 
buf_mgr
[
i
].
äame
);

1382 
	`mem£t
(
buf_mgr
[
i
].
äame
, 0, (
Page
));

1383 
buf_mgr
[
i
].
bË_id
 = 0;

1384 
buf_mgr
[
i
].
·ge_off£t
 = 0;

1385 
buf_mgr
[
i
].
is_dœty
 = 0;

1386 
buf_mgr
[
i
].
»fb™
 = 0;

1391 
bË_ids
[
bË_id
 -1] = 0;

1394 
	`şo£_db
(
bË_id
);

1397 
	}
}

1399 
	$shutdown_db
(){

1400 
i
,
bË_id
 = -1;

1403 if(
buf_size
 =ğ-1 || 
buf_mgr
 =ğ
NULL
){

1407 
i
 = 0; i < 
buf_size
; i++){

1409 if(
buf_mgr
[
i
].
is_dœty
 == 1){

1410 
bË_id
 = 
buf_mgr
[
i
].table_id;

1411 
	`æush_·ge
(
bË_id
, 
buf_mgr
[
i
].
äame
);

1414 if(1 <ğ
buf_mgr
[
i
].
bË_id
 && buf_mgr[i].table_id <= 10){

1415 
	`ä“
(
buf_mgr
[
i
].
äame
);

1420 
	`ä“
(
buf_mgr
);

1423 
	}
}

1425 
	$lßd_·ge_äom_bufãr
(
bË_id
, 
off_t
 
off£t
, 
Page
* 
·ge
){

1426 
Page
 *
‹mp
;

1427 
buf_šdex
 = -1;

1429 
‹mp
 = 
	`check_bufãr_fÜ_lßd
(
bË_id
, 
off£t
);

1432 if(
‹mp
 !ğ
NULL
){

1434 
	`memıy
(
·ge
, 
‹mp
, (
Page
));

1435 
·ge
->
fe_off£t
 = 
off£t
;

1442 
buf_šdex
 = 
	`»¶aû_·ge
(
NULL
);

1445 
	`lßd_·ge
(
bË_id
, 
off£t
, 
·ge
);

1446 
·ge
->
fe_off£t
 = 
off£t
;

1453 
	`memıy
(
buf_mgr
[
buf_šdex
].
äame
, 
·ge
, (
Page
));

1454 
buf_mgr
[
buf_šdex
].
bË_id
 =able_id;

1455 
buf_mgr
[
buf_šdex
].
·ge_off£t
 = 
off£t
;

1456 
buf_mgr
[
buf_šdex
].
is_dœty
 = 0;

1457 
buf_mgr
[
buf_šdex
].
»fb™
 = 1;

1459 
	}
}

1460 
Page
* 
	$check_bufãr_fÜ_lßd
(
bË_id
, 
off_t
 
off£t
){

1461 
i
;

1463 if(
buf_size
 == -1){

1465  
NULL
;

1468 
i
 = 0; i < 
buf_size
; i++){

1469 if(
buf_mgr
[
rg‘_buf
].
bË_id
 =ğbË_id && buf_mgr[rg‘_buf].
·ge_off£t
 =ğ
off£t
){

1471 
buf_mgr
[
rg‘_buf
].
»fb™
 = 1;

1473  
buf_mgr
[
rg‘_buf
].
äame
;

1475 
rg‘_buf
 = (rg‘_buà+ 1è% 
buf_size
;

1479  
NULL
;

1480 
	}
}

1481 
	$check_bufãr_fÜ_æush
(
bË_id
, 
off_t
 
off£t
){

1482 
i
;

1484 if(
buf_size
 == -1){

1489 
i
 = 0; i < 
buf_size
; i++){

1490 if(
buf_mgr
[
rg‘_buf
].
bË_id
 =ğbË_id && buf_mgr[rg‘_buf].
·ge_off£t
 =ğ
off£t
){

1492 
buf_mgr
[
rg‘_buf
].
»fb™
 = 1;

1494  
rg‘_buf
;

1496 
rg‘_buf
 = (rg‘_buà+ 1è% 
buf_size
;

1501 
	}
}

1503 
	$»¶aû_·ge
(
FILE
 *
fe
){

1505 
rg‘_šdex
 = -1;

1508 
rg‘_šdex
 == -1){

1511 if(
buf_mgr
[
şock_hªd
].
»fb™
 == 0){

1513 
rg‘_šdex
 = 
şock_hªd
;

1516 if(
buf_mgr
[
şock_hªd
].
bË_id
 == -1){

1517 
i
;

1518 
OuutPage
 *
rg‘
;

1520 
	`memıy
((
Page
 *)
rg‘
, 
buf_mgr
[
şock_hªd
].
äame
, (Page));

1522 
i
 = 0; i < 
rg‘
->
fe_off£t
; i++){

1523 
	`årštf
(
fe
, "%" 
PRIu64
 ",%s," "%" PRIu64 ",%s\n", 
	`RESULT_KEY1
(
rg‘
, 
i
), 
	`RESULT_VALUE1
Ñ¬g‘, i), 
	`RESULT_KEY2
Ñ¬g‘, i), 
	`RESULT_VALUE2
(target, i) );

1526 
buf_mgr
[
şock_hªd
].
is_dœty
 = 0;

1530 if(
buf_mgr
[
şock_hªd
].
is_dœty
 == 1){

1533 
	`execu‹_w®
();

1536 
	`æush_·ge
(
buf_mgr
[
şock_hªd
].
bË_id
, buf_mgr[şock_hªd].
äame
);

1540 
	`mem£t
(
buf_mgr
[
şock_hªd
].
äame
, 0, (
Page
));

1541 
buf_mgr
[
şock_hªd
].
bË_id
 = 0;

1542 
buf_mgr
[
şock_hªd
].
·ge_off£t
 = 0;

1543 
buf_mgr
[
şock_hªd
].
is_dœty
 = 0;

1544 
buf_mgr
[
şock_hªd
].
»fb™
 = 0;

1550 if(
buf_mgr
[
şock_hªd
].
»fb™
 == 1){

1551 
buf_mgr
[
şock_hªd
].
»fb™
 = 0;

1555 
şock_hªd
 = (şock_hªd + 1è% 
buf_size
;

1559  
rg‘_šdex
;

1560 
	}
}

1563 
	$æush_·ge_to_bufãr
(
bË_id
, 
Page
 *
·ge
){

1564 
i
, 
buf_šdex
 = -1, 
šdex
 = -1;

1569 
šdex
 = 
	`check_bufãr_fÜ_æush
(
bË_id
, 
·ge
->
fe_off£t
);

1572 if(
šdex
 != -1){

1573 
	`memıy
(
buf_mgr
[
rg‘_buf
].
äame
, 
·ge
, (
Page
));

1574 
buf_mgr
[
rg‘_buf
].
is_dœty
 = 1;

1579 
buf_šdex
 = 
	`»¶aû_·ge
(
NULL
);

1583 
	`memıy
(
buf_mgr
[
buf_šdex
].
äame
, 
·ge
, (
Page
));

1584 
buf_mgr
[
buf_šdex
].
bË_id
 =able_id;

1585 
buf_mgr
[
buf_šdex
].
·ge_off£t
 = 
·ge
->
fe_off£t
;

1587 
buf_mgr
[
buf_šdex
].
is_dœty
 = 1;

1588 
buf_mgr
[
buf_šdex
].
»fb™
 = 1;

1590 
	}
}

1595 
	$još_bË
(
bË_id_1
, 
bË_id_2
, *
·thÇme
){

1596 
FILE
 *
r_å
;

1597 
ušt64_t
 
num_1
 = -1, 
num_2
 = -1, 
mš_1
 = -1, 
mš_2
 = -1, 
max_1
 = -1, 
max_2
 = -1;

1598 
L—fPage
 
Ëaf_1
, 
Ëaf_2
;

1599 
off_t
 
comp_sib_1
, 
comp_sib_2
;

1600 
comp_num_1
, 
comp_num_2
;

1601 
ušt64_t
 
comp_key_1
, 
comp_key_2
;

1604 if((
r_å
 = 
	`fİ’
(
·thÇme
, "wt")è=ğ
NULL
){

1609 
	`bË_šfo
(
bË_id_1
, &
num_1
, &
mš_1
, &
max_1
);

1610 
	`bË_šfo
(
bË_id_2
, &
num_2
, &
mš_2
, &
max_2
);

1618 if(
max_1
 < 
mš_2
 || 
mš_1
 > 
max_2
){

1620 
	`fşo£
(
r_å
);

1631 if(
mš_1
 < 
mš_2
){

1634 
	`fšd_Ëaf
(
bË_id_1
, 
mš_2
, &
Ëaf_1
);

1635 
	`fšd_Ëaf
(
bË_id_2
, 
mš_2
, &
Ëaf_2
);

1641 
	`fšd_Ëaf
(
bË_id_1
, 
mš_1
, &
Ëaf_1
);

1642 
	`fšd_Ëaf
(
bË_id_2
, 
mš_1
, &
Ëaf_2
);

1646 
comp_sib_1
 = 
Ëaf_1
.
siblšg
;

1647 
comp_sib_2
 = 
Ëaf_2
.
siblšg
;

1648 
comp_num_1
 = 0;

1649 
comp_num_2
 = 0;

1656 (
comp_sib_1
 !ğ0 || 
comp_num_1
 !ğ
Ëaf_1
.
num_keys
è&& (
comp_sib_2
 !ğ0 || 
comp_num_2
 !ğ
Ëaf_2
.num_keys)){

1658 
comp_key_1
 = 
	`LEAF_KEY
(&
Ëaf_1
, 
comp_num_1
);

1659 
comp_key_2
 = 
	`LEAF_KEY
(&
Ëaf_2
, 
comp_num_2
);

1662 
comp_key_1
 < 
comp_key_2
){

1664 
comp_num_1
++;

1667 if((
comp_num_1
 =ğ
Ëaf_1
.
num_keys
è&& (
comp_sib_1
 != 0)){

1669 
	`lßd_·ge_äom_bufãr
(
bË_id_1
, 
comp_sib_1
, (
Page
*)&
Ëaf_1
);

1672 
comp_sib_1
 = 
Ëaf_1
.
siblšg
;

1675 
comp_num_1
 = 0;

1679 if(
comp_sib_1
 =ğ0 && 
comp_num_1
 =ğ
Ëaf_1
.
num_keys
){

1680 
	`sync_bufãr
(
r_å
);

1681 
	`fşo£
(
r_å
);

1686 
comp_key_1
 = 
	`LEAF_KEY
(&
Ëaf_1
, 
comp_num_1
);

1688 
comp_key_1
 > 
comp_key_2
){

1690 
comp_num_2
++;

1693 if((
comp_num_2
 =ğ
Ëaf_2
.
num_keys
è&& (
comp_sib_2
 != 0)){

1695 
	`lßd_·ge_äom_bufãr
(
bË_id_2
, 
comp_sib_2
, (
Page
*)&
Ëaf_2
);

1698 
comp_sib_2
 = 
Ëaf_2
.
siblšg
;

1701 
comp_num_2
 = 0;

1705 if(
comp_sib_1
 =ğ0 && 
comp_num_1
 =ğ
Ëaf_1
.
num_keys
){

1706 
	`sync_bufãr
(
r_å
);

1707 
	`fşo£
(
r_å
);

1712 
comp_key_2
 = 
	`LEAF_KEY
(&
Ëaf_2
, 
comp_num_2
);

1715 if(
comp_key_1
 =ğ
comp_key_2
){

1718 
	`wr™e_ouut_bufãr
(
r_å
, 
comp_key_1
, 
	`LEAF_VALUE
(&
Ëaf_1
, 
comp_num_1
), 
comp_key_2
, LEAF_VALUE(&
Ëaf_2
, 
comp_num_2
));

1722 
comp_num_1
++;

1723 
comp_num_2
++;

1726 if((
comp_num_1
 =ğ
Ëaf_1
.
num_keys
è&& (
comp_sib_1
 != 0)){

1728 
	`lßd_·ge_äom_bufãr
(
bË_id_1
, 
comp_sib_1
, (
Page
*)&
Ëaf_1
);

1731 
comp_sib_1
 = 
Ëaf_1
.
siblšg
;

1734 
comp_num_1
 = 0;

1738 if((
comp_num_2
 =ğ
Ëaf_2
.
num_keys
è&& (
comp_sib_2
 != 0)){

1740 
	`lßd_·ge_äom_bufãr
(
bË_id_2
, 
comp_sib_2
, (
Page
*)&
Ëaf_2
);

1743 
comp_sib_2
 = 
Ëaf_2
.
siblšg
;

1746 
comp_num_2
 = 0;

1752 
	`sync_bufãr
(
r_å
);

1753 
	`fşo£
(
r_å
);

1755 
	}
}

1756 
	$bË_šfo
(
bË_id
, 
ušt64_t
 *
num_keys
, ušt64_ˆ*
mš_key
, ušt64_ˆ*
max_key
){

1757 
H—d”Page
 
‹mp_h—d”
;

1758 
NodePage
 
·ge
;

1759 
L—fPage
 *
‹mp_Ëaf
;

1760 
off_t
 
‹mp_siblšg
;

1763 
	`lßd_·ge_äom_bufãr
(
bË_id
, 0, (
Page
*)(&
‹mp_h—d”
));

1766 if(
‹mp_h—d”
.
roÙ_off£t
 == 0){

1767 *
num_keys
 = 0;

1768 *
max_key
 = 0;

1774 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
‹mp_h—d”
.
roÙ_off£t
, (
Page
*)&
·ge
);

1777 !
·ge
.
is_Ëaf
){

1778 
IÁ”ÇlPage
* 
š‹º®_node
 = (IÁ”ÇlPage*)&
·ge
;

1780 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
	`INTERNAL_OFFSET
(
š‹º®_node
, 0), (
Page
*)&
·ge
);

1787 
‹mp_Ëaf
 = (
L—fPage
 *)&
·ge
;

1789 *
num_keys
 = 
‹mp_Ëaf
->num_keys;

1790 *
mš_key
 = 
	`LEAF_KEY
(
‹mp_Ëaf
, 0);

1791 *
max_key
 = 
	`LEAF_KEY
(
‹mp_Ëaf
,emp_Ëaf->
num_keys
 - 1);

1792 
‹mp_siblšg
 = 
‹mp_Ëaf
->
siblšg
;

1794 
‹mp_siblšg
 != 0){

1796 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
‹mp_siblšg
, (
Page
*)
‹mp_Ëaf
);

1798 *
num_keys
 +ğ
‹mp_Ëaf
->num_keys;

1799 *
max_key
 = 
	`LEAF_KEY
(
‹mp_Ëaf
,emp_Ëaf->
num_keys
 - 1);

1800 
‹mp_siblšg
 = 
‹mp_Ëaf
->
siblšg
;

1803 
	}
}

1804 
	$wr™e_ouut_bufãr
(
FILE
 *
fe
, 
ušt64_t
 
key1
, *
v®ue1
, ušt64_ˆ
key2
, *
v®ue2
){

1805 
OuutPage
 
ouut
;

1808 if(
	`lßd_ouut_·ge
((
Page
*)&
ouut
) == -1){

1809 
ouut
.
»suÉs
[0].
key1
 = key1;

1810 
	`¡rıy
(
ouut
.
»suÉs
[0].
v®ue1
, value1);

1811 
ouut
.
»suÉs
[0].
key2
 = key2;

1812 
	`¡rıy
(
ouut
.
»suÉs
[0].
v®ue2
, value2);

1813 
ouut
.
fe_off£t
 = 1;

1818 if(
ouut
.
fe_off£t
 < 
OUTPUT_ORDER
){

1819 
	`RESULT_KEY1
(&
ouut
, ouut.
fe_off£t
èğ
key1
;

1820 
	`¡rıy
(
	`RESULT_VALUE1
(&
ouut
, ouut.
fe_off£t
), 
v®ue1
);

1821 
	`RESULT_KEY2
(&
ouut
, ouut.
fe_off£t
èğ
key2
;

1822 
	`¡rıy
(
	`RESULT_VALUE2
(&
ouut
, ouut.
fe_off£t
), 
v®ue2
);

1824 
ouut
.
fe_off£t
++;

1828 
OuutPage
 
Ãw
;

1830 
	`sync_bufãr
(
fe
);

1832 
Ãw
.
»suÉs
[0].
key1
 = key1;

1833 
	`¡rıy
(
Ãw
.
»suÉs
[0].
v®ue1
, value1);

1834 
Ãw
.
»suÉs
[0].
key2
 = key2;

1835 
	`¡rıy
(
Ãw
.
»suÉs
[0].
v®ue2
, value2);

1836 
Ãw
.
fe_off£t
 = 1;

1838 
	`æush_ouut_·ge
(
fe
, (
Page
 *)&
Ãw
);

1843 
	`æush_ouut_·ge
(
fe
, (
Page
 *)&
ouut
);

1844 
	}
}

1845 
	$lßd_ouut_·ge
(
Page
 *
·ge
){

1846 
Page
 *
‹mp
;

1848 
‹mp
 = 
	`check_bufãr_fÜ_lßd
(-1, 0);

1851 if(
‹mp
 !ğ
NULL
){

1853 
	`memıy
(
·ge
, 
‹mp
, (
Page
));

1863 
	}
}

1864 
	$æush_ouut_·ge
(
FILE
 *
fe
, 
Page
 *
·ge
){

1865 
i
, 
buf_šdex
 = -1, 
šdex
 = -1;

1870 
šdex
 = 
	`check_bufãr_fÜ_æush
(-1, 0);

1873 if(
šdex
 != -1){

1874 
	`memıy
(
buf_mgr
[
rg‘_buf
].
äame
, 
·ge
, (
Page
));

1875 
buf_mgr
[
rg‘_buf
].
is_dœty
 = 1;

1880 
buf_šdex
 = 
	`»¶aû_·ge
(
fe
);

1884 
	`memıy
(
buf_mgr
[
buf_šdex
].
äame
, 
·ge
, (
Page
));

1885 
buf_mgr
[
buf_šdex
].
bË_id
 = -1;

1886 
buf_mgr
[
buf_šdex
].
·ge_off£t
 = 0;

1888 
buf_mgr
[
buf_šdex
].
is_dœty
 = 1;

1889 
buf_mgr
[
buf_šdex
].
»fb™
 = 1;

1891 
	}
}

1892 
	$sync_bufãr
(
FILE
 *
fe
){

1893 
i
, 
šdex
, 
’d
;

1894 
OuutPage
 
rg‘
;

1896 
šdex
 = 
	`check_bufãr_fÜ_æush
(-1, 0);

1898 
	`memıy
((
Page
 *)&
rg‘
, 
buf_mgr
[
šdex
].
äame
, (Page));

1899 
i
 = 0; i < 
rg‘
.
fe_off£t
; i++){

1900 
	`årštf
(
fe
, "%" 
PRIu64
 ",%s," "%" PRIu64 ",%s\n", 
	`RESULT_KEY1
(&
rg‘
, 
i
), 
	`RESULT_VALUE1
(&rg‘, i), 
	`RESULT_KEY2
(&rg‘, i), 
	`RESULT_VALUE2
(&target, i) );

1904 
	`mem£t
(
buf_mgr
[
šdex
].
äame
, 0, (
Page
));

1905 
buf_mgr
[
šdex
].
bË_id
 = 0;

1906 
buf_mgr
[
šdex
].
·ge_off£t
 = 0;

1907 
buf_mgr
[
šdex
].
is_dœty
 = 0;

1908 
buf_mgr
[
šdex
].
»fb™
 = 0;

1909 
	}
}

1912 
	$begš_Œª§ùiÚ
(){

1915 ià(
log
 < 0) {

1917 
log
 = 
	`İ’
("log.db", 
O_CREAT
|
O_RDWR
, 
S_IRUSR
|
S_IWUSR
);

1918 ià(
log
 < 0) {

1919 
	`as£¹
("failedo create‚ew†og file");

1926 
xid
++;

1929 
	`ü—‹_log
(0, 0, 0, 0, 0, 
NULL
, NULL);

1932 
	}
}

1933 
	$comm™_Œª§ùiÚ
(){

1935 
	`ü—‹_log
(2, 0, 0, 0, 0, 
NULL
, NULL);

1936 
	`æush_log
(
log_hªd
);

1937 
	`fsync
(
log
);

1938 
log_hªd
 = 0;

1941 
	}
}

1942 
	$abÜt_Œª§ùiÚ
(){

1945 
	}
}

1946 
	$upd©e
(
bË_id
, 
št64_t
 
key
, *
v®ue
){

1947 
Şd
[120];

1949 if(
	`fšd
(
bË_id
, 
key
è=ğ
NULL
 || 
dbh—d”
[bË_id -1].
roÙ_off£t
 == 0){

1955 
L—fPage
 
Ëaf_node
;

1956 
fix_pošt
 = 0, 
loÿtiÚ
;

1958 
	`fšd_Ëaf
(
bË_id
, 
key
, &
Ëaf_node
);

1960 
fix_pošt
 < 
Ëaf_node
.
num_keys
 && 
	`LEAF_KEY
(&Ëaf_node, fix_poštè!ğ
key
){

1961 
fix_pošt
++;

1964 
	`¡rıy
(
Şd
, 
	`LEAF_VALUE
(&
Ëaf_node
, 
fix_pošt
));

1966 
	`memıy
(
	`LEAF_VALUE
(&
Ëaf_node
, 
fix_pošt
), 
v®ue
, 
SIZE_VALUE
);

1969 
Ëaf_node
.
·ge_l¢
 = 
l¢
;

1973 
loÿtiÚ
 = 
Ëaf_node
.
fe_off£t
 + 128 + (
fix_pošt
 * 128) + 8;

1974 
	`ü—‹_log
(1, 
bË_id
, 
loÿtiÚ
 / 
PAGE_SIZE
,†oÿtiÚ % PAGE_SIZE, 
	`¡¾’
(
v®ue
), 
Şd
,value);

1977 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
Ëaf_node
);

1981 
	}
}

1983 
	$ü—‹_log
(
ty³
, 
bË_id
, 
²um
, 
off£t
, 
Ëngth
, *
Şd_image
, *
Ãw_image
){

1984 
LogRecÜd
 
Ãw_log
;

1987 
Ãw_log
.
l¢
 =†sn;

1988 
Ãw_log
.
´ev_l¢
 = 
l¢
 - 
SIZE_LOG
;

1989 
Ãw_log
.
xid
 = xid;

1990 
Ãw_log
.
ty³
 =ype;

1991 
Ãw_log
.
bË_id
 =able_id;

1992 
Ãw_log
.
²um
 =…num;

1993 
Ãw_log
.
off£t
 = offset;

1994 
Ãw_log
.
Ëngth
 =†ength;

1995 if(
Şd_image
 !ğ
NULL
 & 
Ãw_image
 != NULL){

1996 
	`¡rıy
(
Ãw_log
.
Şd_image
, old_image);

1997 
	`¡rıy
(
Ãw_log
.
Ãw_image
,‚ew_image);

2001 
l¢
 +ğ
SIZE_LOG
;

2005 if(
log_hªd
 =ğ
SIZE_LOG_BUFFER
){

2007 
	`æush_log
(
SIZE_LOG_BUFFER
 / 3);

2008 
	`fsync
(
log
);

2010 
log_buf
[
log_hªd
++] = 
Ãw_log
;

2011 
	}
}

2013 
	$æush_log
(
size
){

2014 
i
 = 0;

2017 
i
 = 0; i < 
size
; i++){

2018 
	`l£ek
(
log
, 
log_buf
[
i
].
´ev_l¢
, 
SEEK_SET
);

2019 
	`wr™e
(
log
, 
log_buf
 + 
i
, 
SIZE_LOG
);

2023 
i
 = 
size
; i < 
SIZE_LOG_BUFFER
; i++){

2024 
log_buf
[
i
-
size
] =†og_buf[i];

2028 
log_hªd
 -ğ
size
;

2029 
	}
}

2030 
	$»cov”y
(){

2031 
LogRecÜd
 
»do
;

2032 
off_t
 
fe_size
, 
off£t
 = 0;

2033 
i
;

2036 
fe_size
 = 
	`l£ek
(
log
, 0, 
SEEK_END
);

2038 
i
 = 0; i < 
fe_size
 / 
SIZE_LOG
; i++){

2039 
	`l£ek
(
log
, 
off£t
, 
SEEK_SET
);

2040 
	`»ad
(
log
, &
»do
, 
SIZE_LOG
);

2041 
	`´štf
("%d %d %d %d %d %d %d %d % %s\n", ()
»do
.
l¢
, (ìedo.
´ev_l¢
,„edo.
xid
,„edo.
ty³
,„edo.
bË_id
,„edo.
²um
,„edo.
off£t
,„edo.
Ëngth
,„edo.
Şd_image
,„edo.
Ãw_image
);

2042 
off£t
 +ğ
SIZE_LOG
;

2044 
	}
}

	@src/file.c

1 
	~<sys/ty³s.h
>

2 
	~<fú.h
>

3 
	~<¡dlib.h
>

4 
	~<as£¹.h
>

5 
	~<¡dio.h
>

6 
	~<uni¡d.h
>

7 
	~<¡ršg.h
>

8 
	~"fe.h
"

10 
H—d”Page
 
	gdbh—d”
[10];

11 
	gdbfe
[10] = {0,};

15 
off_t
 
	$g‘_ä“_·ge
(
bË_id
) {

16 
off_t
 
ä“·ge_off£t
;

18 
ä“·ge_off£t
 = 
dbh—d”
[
bË_id
 - 1].
ä“li¡
;

19 ià(
ä“·ge_off£t
 == 0) {

21 
	`ex·nd_fe
(
bË_id
, 
dbh—d”
[bË_id - 1].
num_·ges
);

22 
ä“·ge_off£t
 = 
dbh—d”
[
bË_id
 - 1].
ä“li¡
;

25 
F»ePage
 
ä“·ge
;

26 
	`lßd_·ge_äom_bufãr
(
bË_id
, 
ä“·ge_off£t
, (
Page
*)&
ä“·ge
);

27 
dbh—d”
[
bË_id
 - 1].
ä“li¡
 = 
ä“·ge
.
Ãxt
;

29 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)(
dbh—d”
 +able_id - 1));

31  
ä“·ge_off£t
;

32 
	}
}

35 
	$put_ä“_·ge
(
bË_id
, 
off_t
 
·ge_off£t
) {

36 
F»ePage
 
ä“·ge
;

37 
	`mem£t
(&
ä“·ge
, 0, 
PAGE_SIZE
);

39 
ä“·ge
.
Ãxt
 = 
dbh—d”
[
bË_id
 - 1].
ä“li¡
;

40 
ä“·ge
.
fe_off£t
 = 
·ge_off£t
;

42 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)&
ä“·ge
);

44 
dbh—d”
[
bË_id
 - 1].
ä“li¡
 = 
·ge_off£t
;

46 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)(
dbh—d”
 +able_id - 1));

47 
	}
}

50 
	$ex·nd_fe
(
bË_id
, 
size_t
 
út_·ge_to_ex·nd
) {

51 
off_t
 
off£t
 = 
dbh—d”
[
bË_id
 - 1].
num_·ges
 * 
PAGE_SIZE
;

53 ià(
dbh—d”
[
bË_id
 - 1].
num_·ges
 > 1024 * 1024) {

55 
	`as£¹
("Test: you‡re‡lready having‡ DB file overhan 4GB");

58 
i
;

59 
i
 = 0; i < 
út_·ge_to_ex·nd
; i++) {

60 
	`put_ä“_·ge
(
bË_id
, 
off£t
);

61 
dbh—d”
[
bË_id
 - 1].
num_·ges
++;

62 
off£t
 +ğ
PAGE_SIZE
;

65 
	`æush_·ge_to_bufãr
(
bË_id
, (
Page
*)(
dbh—d”
 +able_id - 1));

66 
	}
}

68 
	$lßd_·ge
(
bË_id
, 
off_t
 
off£t
, 
Page
* 
·ge
) {

69 
	`l£ek
(
dbfe
[
bË_id
 - 1], 
off£t
, 
SEEK_SET
);

70 
	`»ad
(
dbfe
[
bË_id
 - 1], 
·ge
, 
PAGE_SIZE
);

71 
·ge
->
fe_off£t
 = 
off£t
;

72 
	}
}

74 
	$æush_·ge
(
bË_id
, 
Page
* 
·ge
) {

75 
	`l£ek
(
dbfe
[
bË_id
 - 1], 
·ge
->
fe_off£t
, 
SEEK_SET
);

76 
	`wr™e
(
dbfe
[
bË_id
 - 1], 
·ge
, 
PAGE_SIZE
);

77 
	}
}

	@src/main.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<fú.h
>

4 
	~<uni¡d.h
>

5 
	~<sys/ty³s.h
>

6 
	~<š‰y³s.h
>

7 
	~"b±.h
"

8 
	~"fe.h
"

9 
	~<¡ršg.h
>

10 
	~<time.h
>

13 
	$maš
Ğ
¬gc
, ** 
¬gv
 ) {

14 
šput_v®ue_1
[
SIZE_VALUE
], 
šput_v®ue_2
[SIZE_VALUE];

15 
ušt64_t
 
¡¬t
, 
’d
, 
jump
;

16 
bË_1
 = 0, 
bË_2
 = 0, 
bË_10
 = 0;

17 
time_t
 
¡¬t_t
, 
’d_t
;

19 
	`´štf
("Welcomeo„ecoveryest\n");

21 
	`š™_db
(100);

23 
bË_1
 = 
	`İ’_bË
("DATA1");

24 
bË_2
 = 
	`İ’_bË
("DATA2");

26 
	`š£¹
(
bË_1
, 1, "A");

27 
	`š£¹
(
bË_1
, 2, "B");

28 
	`š£¹
(
bË_2
, 1, "C");

29 
	`š£¹
(
bË_2
, 2, "D");

36 
	`begš_Œª§ùiÚ
();

37 
	`upd©e
(
bË_1
, 1, "table1_A");

38 
	`upd©e
(
bË_1
, 2, "table1_B");

39 
	`upd©e
(
bË_2
, 1, "table2_C");

40 
	`upd©e
(
bË_2
, 2, "table2_D");

41 
	`comm™_Œª§ùiÚ
();

48 
	`şo£_bË
(
bË_1
);

49 
	`şo£_bË
(
bË_2
);

51 
	`»move
("DATA1");

52 
	`»move
("DATA2");

54  
EXIT_SUCCESS
;

55 
	}
}

	@
1
.
0
5
61
include/bpt.h
include/file.h
src/bpt.c
src/file.c
src/main.c
